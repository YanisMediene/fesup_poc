# ===================================================================
# Fichier de configuration pour le déploiement sur Render.com
# Inspiré du docker-compose.yml
# ===================================================================

services:
  # ========== SERVICE 1 : BASE DE DONNÉES POSTGRESQL ==========
  - type: psql
    name: fesup-db
    region: frankfurt
    plan: free # Choisissez un plan adapté à vos besoins
    postgresMajorVersion: 16
    disk:
      name: fesup-postgres-data
      sizeGB: 1
      mountPath: /var/lib/postgresql/data

  # ========== SERVICE 2 : BACKEND (SPRING BOOT) ==========
  - type: web
    name: fesup-backend
    region: frankfurt
    plan: free # Choisissez un plan adapté à vos besoins
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheck:
      path: /actuator/health
      initialDelaySeconds: 60
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: update
      - key: SPRING_JPA_SHOW_SQL
        value: false
      # Connexion à la base de données (injectée par Render)
      - fromService:
          type: psql
          name: fesup-db
          envVarKey: SPRING_DATASOURCE_URL
      - fromService:
          type: psql
          name: fesup-db
          envVarKey: SPRING_DATASOURCE_USERNAME
      - fromService:
          type: psql
          name: fesup-db
          envVarKey: SPRING_DATASOURCE_PASSWORD
      # Configuration du stockage des tickets
      - key: APPLICATION_TICKETS_STORAGE_PATH
        value: /app/tickets
      # Configuration JVM
      - key: JAVA_OPTS
        value: -Xmx512m -Xms256m -XX:+UseG1GC
    disk:
      name: fesup-tickets-storage
      sizeGB: 1
      mountPath: /app/tickets

  # ========== SERVICE 3 : FRONTEND (ANGULAR + NGINX) ==========
  - type: web
    name: fesup-frontend
    region: frankfurt
    plan: free # Choisissez un plan adapté à vos besoins
    env: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    healthCheck:
      path: /
      initialDelaySeconds: 30
    routes:
      - type: rewrite
        source: /api/*
        destination: /api/*
    # Redirection des requêtes /api/* vers le backend
    rewrites:
      - source: /api/:path*
        destination: https://fesup-backend.onrender.com/api/:path*

    envVars:
      - key: BACKEND_URL
        value: https://fesup-backend.onrender.com
