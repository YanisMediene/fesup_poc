# ============================================
# Render.com Blueprint - Application FESUP
# Déploiement automatique : PostgreSQL + Backend + Frontend
# ============================================

services:
  # ========== SERVICE 1 : BASE DE DONNÉES POSTGRESQL ==========
  - type: pserv
    name: fesup-postgres
    plan: free
    region: frankfurt
    databases:
      - name: fesup_db
        databaseName: fesup_db
        user: fesup_user

  # ========== SERVICE 2 : BACKEND (SPRING BOOT) ==========
  - type: web
    name: fesup-backend
    env: docker
    plan: free
    region: frankfurt
    branch: main
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    
    envVars:
      # Configuration Spring Boot
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      
      # URL base de données (injectée automatiquement par Render)
      - key: DATABASE_URL
        fromDatabase:
          name: fesup-postgres
          property: connectionString
      
      # Port dynamique Render (injecté automatiquement par la plateforme)
      # Pas besoin de définir PORT - Render l'injecte automatiquement
      
      # Options JVM optimisées pour 512MB RAM
      - key: JAVA_OPTS
        value: "-Xmx450m -Xms256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=80.0"
      
      # URL frontend pour CORS (sera mise à jour automatiquement)
      - key: FRONTEND_URL
        fromService:
          type: web
          name: fesup-frontend
          property: hostAndPort
      
      # Stockage tickets (database pour éviter perte de données)
      - key: TICKETS_STORAGE_TYPE
        value: database
    
    # Health check endpoint
    healthCheckPath: /api/actuator/health
    
    # Auto-deploy à chaque push sur main
    autoDeploy: true

  # ========== SERVICE 3 : FRONTEND (ANGULAR + NGINX) ==========
  - type: web
    name: fesup-frontend
    env: docker
    plan: free
    region: frankfurt
    branch: main
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    
    envVars:
      # URL backend (injectée automatiquement par Render)
      - key: BACKEND_URL
        fromService:
          type: web
          name: fesup-backend
          property: host
      
      # Port dynamique Render (injecté automatiquement par la plateforme)
      # Pas besoin de définir PORT - Render l'injecte automatiquement
    
    # Health check endpoint
    healthCheckPath: /health
    
    # Auto-deploy à chaque push sur main
    autoDeploy: true
