# Documentation Technique - Projet FESUP

## ğŸ“‹ Table des MatiÃ¨res

1. Architecture Globale
2. SchÃ©ma de Base de DonnÃ©es
3. API Endpoints
4. Services et Logique MÃ©tier
5. Frontend - Structure des Composants
6. DÃ©ploiement
7. SÃ©curitÃ©

---

## Architecture Globale

### Vue d'ensemble N-Tiers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NAVIGATEUR CLIENT                        â”‚
â”‚                    (http://localhost)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FRONTEND - Angular 17 + Nginx                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Composants Angular (Standalone & NgModule)        â”‚  â”‚
â”‚  â”‚  â€¢ Services (HTTP Client)                            â”‚  â”‚
â”‚  â”‚  â€¢ Guards (Auth, Voeux)                              â”‚  â”‚
â”‚  â”‚  â€¢ Interceptors (JWT)                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Nginx (Port 80)                                      â”‚  â”‚
â”‚  â”‚  â€¢ Serveur de fichiers statiques                     â”‚  â”‚
â”‚  â”‚  â€¢ Reverse Proxy : /api/* â†’ backend:8080             â”‚  â”‚
â”‚  â”‚  â€¢ Fallback routing pour SPA                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP/REST
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND - Spring Boot 3.2.0                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Controllers (@RestController)                        â”‚  â”‚
â”‚  â”‚  â€¢ VoeuxController (public)                          â”‚  â”‚
â”‚  â”‚  â€¢ AdminControllers (secured)                        â”‚  â”‚
â”‚  â”‚  â€¢ AffectationController                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services (Business Logic)                            â”‚  â”‚
â”‚  â”‚  â€¢ VoeuxService (validation complexe)                â”‚  â”‚
â”‚  â”‚  â€¢ AffectationService (Timefold)                     â”‚  â”‚
â”‚  â”‚  â€¢ BatchPdfService (gÃ©nÃ©ration asynchrone)           â”‚  â”‚
â”‚  â”‚  â€¢ SessionGenerationService                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Repositories (Spring Data JPA)                       â”‚  â”‚
â”‚  â”‚  â€¢ EleveRepository                                    â”‚  â”‚
â”‚  â”‚  â€¢ ActiviteRepository                                â”‚  â”‚
â”‚  â”‚  â€¢ VoeuRepository, etc.                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚ JPA/Hibernate                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ JDBC
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DATABASE - PostgreSQL 16                        â”‚
â”‚  â€¢ Base: fesup_db                                           â”‚
â”‚  â€¢ Port interne: 5432                                       â”‚
â”‚  â€¢ Port externe (dev): 5434                                 â”‚
â”‚  â€¢ Volume persistant: postgres_data                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STOCKAGE FICHIERS                               â”‚
â”‚  â€¢ Volume Docker: tickets_storage                           â”‚
â”‚  â€¢ Path: /app/tickets/{annÃ©e}/eleve_{id}.pdf               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Communication Docker Compose

```yaml
Services:
  - db (postgres:16-alpine)
  - backend (Spring Boot)
  - frontend (Angular + Nginx)

Network: fesup-network (bridge)

Volumes:
  - postgres_data (BDD)
  - tickets_storage (PDFs)

Health Checks:
  - db: pg_isready
  - backend: nc -z localhost 8080
  - frontend: curl localhost:80
```

---

## SchÃ©ma de Base de DonnÃ©es

### EntitÃ©s JPA Principales

#### 1. **Eleve**
```java
@Entity
@Table(name = "eleves")
public class Eleve {
    @Id @GeneratedValue
    private Long id; // ClÃ© primaire technique (auto-increment)
    
    private String nom;
    private String prenom;
    
    @Column(nullable = false, unique = true, length = 50)
    private String idNational; // â­ IDENTIFIANT FONCTIONNEL (ex: 120890177FA)
    
    @ManyToOne
    @JoinColumn(name = "lycee_id")
    private Lycee lycee;
    
    @Enumerated(EnumType.STRING)
    private DemiJournee demiJournee; // JOUR1_MATIN | JOUR1_APRES_MIDI | JOUR2_MATIN | JOUR2_APRES_MIDI
    
    private Boolean voeuxSoumis;
    private LocalDateTime dateSoumission;
    
    @OneToMany(mappedBy = "eleve")
    private List<Voeu> voeux;
    
    @OneToMany(mappedBy = "eleve")
    private List<Affectation> affectations;
    
    @OneToOne(mappedBy = "eleve")
    private Ticket ticket;
}
```

**StratÃ©gie Double Identifiant :**
- **`id` (Long)** : ClÃ© primaire technique utilisÃ©e pour les FK internes
- **`idNational` (String)** : Identifiant fonctionnel utilisÃ© pour l'authentification Ã©lÃ¨ve
  - Format : AlphanumÃ©rique majuscule (ex: `120890177FA`)
  - Longueur : 5-50 caractÃ¨res
  - Contraintes : `UNIQUE`, `NOT NULL`
  - Index crÃ©Ã© automatiquement pour performance

**Relations:**
- `ManyToOne` â†’ Lycee
- `OneToMany` â†’ Voeu (1 Ã©lÃ¨ve a 5 vÅ“ux)
- `OneToMany` â†’ Affectation (rÃ©sultats de l'algorithme)
- `OneToOne` â†’ Ticket (PDF gÃ©nÃ©rÃ©)

---

#### 2. **Lycee**
```java
@Entity
@Table(name = "lycees")
public class Lycee {
    @Id @GeneratedValue
    private Long id;
    
    private String nom;
    private String ville;
    private String codePostal;
    
    @OneToMany(mappedBy = "lycee")
    private List<Eleve> eleves;
}
```

**Relations:**
- `OneToMany` â†’ Eleve

---

#### 3. **Activite**
```java
@Entity
@Table(name = "activites")
public class Activite {
    @Id @GeneratedValue
    private Long id;
    
    private String titre;
    private String description;
    
    @Enumerated(EnumType.STRING)
    private TypeActivite type; // CONFERENCE | TABLE_RONDE | FLASH_METIER
    
    @Enumerated(EnumType.STRING)
    private DemiJournee demiJournee;
    
    private Integer capaciteMax;
    
    @OneToMany(mappedBy = "activite")
    private List<Voeu> voeux;
    
    @OneToMany(mappedBy = "activite")
    private List<Session> sessions;
}
```

**Relations:**
- `OneToMany` â†’ Voeu
- `OneToMany` â†’ Session (instances de l'activitÃ© dans des crÃ©neaux)

---

#### 4. **Voeu** (Table de liaison Eleve-Activite)
```java
@Entity
@Table(name = "voeux")
public class Voeu {
    @Id @GeneratedValue
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "eleve_id")
    private Eleve eleve;
    
    @ManyToOne
    @JoinColumn(name = "activite_id")
    private Activite activite;
    
    private Integer ordre; // 1 Ã  5
    
    @Enumerated(EnumType.STRING)
    private TypeVoeu typeVoeu; // VOEU_1_2 | VOEU_3_4_5
}
```

**Relations:**
- `ManyToOne` â†’ Eleve
- `ManyToOne` â†’ Activite

**Logique mÃ©tier:**
- VÅ“ux 1-2 : obligatoirement des CONFERENCE
- VÅ“ux 3-4-5 : CONFERENCE | TABLE_RONDE | FLASH_METIER
- Pas de doublons entre les 5 vÅ“ux

---

#### 5. **Salle**
```java
@Entity
@Table(name = "salles")
public class Salle {
    @Id @GeneratedValue
    private Long id;
    
    private String nom;
    private Integer capacite;
    private String batiment;
    private String equipements;
    
    @OneToMany(mappedBy = "salle")
    private List<Session> sessions;
}
```

**Relations:**
- `OneToMany` â†’ Session

---

#### 6. **Creneau**
```java
@Entity
@Table(name = "creneaux")
public class Creneau {
    @Id @GeneratedValue
    private Long id;
    
    private LocalTime heureDebut;
    private LocalTime heureFin;
    
    @Enumerated(EnumType.STRING)
    private DemiJournee demiJournee;
    
    @OneToMany(mappedBy = "creneau")
    private List<Session> sessions;
}
```

**Relations:**
- `OneToMany` â†’ Session

---

#### 7. **Session** (Instance d'une Activite dans un Creneau/Salle)
```java
@Entity
@Table(name = "sessions")
public class Session {
    @Id @GeneratedValue
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "activite_id")
    private Activite activite;
    
    @ManyToOne
    @JoinColumn(name = "salle_id")
    private Salle salle;
    
    @ManyToOne
    @JoinColumn(name = "creneau_id")
    private Creneau creneau;
    
    private Integer capaciteEffective;
    
    @OneToMany(mappedBy = "assignedSession")
    private List<Affectation> affectations;
}
```

**Relations:**
- `ManyToOne` â†’ Activite
- `ManyToOne` â†’ Salle
- `ManyToOne` â†’ Creneau
- `OneToMany` â†’ Affectation

---

#### 8. **Affectation** (RÃ©sultat de l'algorithme Timefold)
```java
@Entity
@Table(name = "affectations")
public class Affectation {
    @Id @GeneratedValue
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "eleve_id")
    private Eleve eleve;
    
    @ManyToOne
    @JoinColumn(name = "activite_id")
    private Activite activite;
    
    @ManyToOne
    @JoinColumn(name = "session_id")
    private Session assignedSession; // nullable avant rÃ©solution
    
    private Integer priorite; // 1-5 (basÃ© sur l'ordre des vÅ“ux)
    
    @Enumerated(EnumType.STRING)
    private TypeVoeu typeVoeu;
    
    private Integer scoreAffectation; // calculÃ© par Timefold
}
```

**Relations:**
- `ManyToOne` â†’ Eleve
- `ManyToOne` â†’ Activite
- `ManyToOne` â†’ Session (rÃ©sultat de l'algorithme)

**Logique mÃ©tier:**
- L'algorithme Timefold affecte chaque Ã©lÃ¨ve Ã  5 sessions (1 par vÅ“u).
- Score = satisfaction basÃ©e sur la prioritÃ© des vÅ“ux.

---

#### 9. **Ticket** (PDF gÃ©nÃ©rÃ©)
```java
@Entity
@Table(name = "tickets")
public class Ticket {
    @Id @GeneratedValue
    private Long id;
    
    @OneToOne
    @JoinColumn(name = "eleve_id")
    private Eleve eleve;
    
    private String cheminFichier; // ex: "2025/eleve_123.pdf"
    private LocalDateTime dateGeneration;
    private Long tailleFichier;
    
    @Enumerated(EnumType.STRING)
    private StatutTicket statut; // GENERE | EN_ATTENTE | ERREUR
}
```

**Relations:**
- `OneToOne` â†’ Eleve

---

#### 10. **User** (Administrateurs)
```java
@Entity
@Table(name = "users")
public class User {
    @Id @GeneratedValue
    private Long id;
    
    private String email;
    private String password; // BCrypt
    private String nom;
    private String prenom;
    
    @Enumerated(EnumType.STRING)
    private Role role; // ADMIN | SUPERADMIN
}
```

**SÃ©curitÃ©:**
- Authentification JWT via `/api/auth/login`
- RÃ´les protÃ©gÃ©s par `@PreAuthorize("hasRole('ADMIN')")`

---

### SchÃ©ma Relationnel (ERD SimplifiÃ©)

```
Lycee (1) â”€â”€â”€â”€â”€< (N) Eleve (1) â”€â”€â”€â”€â”€< (N) Voeu >â”€â”€â”€â”€â”€ (N) Activite
                        â”‚                                    â”‚
                        â”‚                                    â”‚
                        â”‚                                    â–¼
                        â”‚                               Session (N) â”€â”€â”€â”€ Salle (1)
                        â”‚                                    â”‚
                        â”‚                                    â”‚
                        â–¼                                    â”‚
                   Affectation (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚
                   Ticket (1:1)

Creneau (1) â”€â”€â”€â”€â”€< (N) Session
```

---

## API Endpoints

### ğŸ”’ **CatÃ©gorie 1 : Authentification**

#### `POST /api/auth/login`
**Description:** Connexion administrateur (gÃ©nÃ¨re un JWT)

**Request Body:**
```json
{
  "email": "admin@fesup.fr",
  "password": "admin123"
}
```

**Response (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "admin@fesup.fr",
  "nom": "Admin",
  "prenom": "Principal",
  "role": "ADMIN"
}
```

**Security:** Public endpoint

---

### ğŸ“ **CatÃ©gorie 2 : Workflow Ã‰lÃ¨ve (Public)**

#### `POST /api/voeux/auth`
**Description:** VÃ©rification de l'identitÃ© de l'Ã©lÃ¨ve (ID + Nom)

**Request Body:**
```json
{
  "eleveId": 1,
  "nom": "DUPONT"
}
```

**Response (200 OK):**
```json
{
  "id": 1,
  "nom": "DUPONT",
  "prenom": "Jean",
  "lycee": "LycÃ©e Victor Hugo",
  "demiJournee": "MATIN",
  "voeuxDejasoumis": false
}
```

**Errors:**
- `404` : Ã‰lÃ¨ve introuvable
- `401` : Nom incorrect

---

#### `GET /api/voeux/activites/{demiJournee}`
**Description:** RÃ©cupÃ©ration des activitÃ©s filtrÃ©es par demi-journÃ©e

**Path Parameter:** `MATIN` | `APRES_MIDI`

**Response (200 OK):**
```json
{
  "conferences": [
    {
      "id": 1,
      "titre": "Intelligence Artificielle et Machine Learning",
      "description": "Introduction Ã  l'IA",
      "type": "CONFERENCE",
      "demiJournee": "MATIN",
      "capaciteMax": 30
    }
  ],
  "tablesRondes": [...],
  "flashsMetiers": [...]
}
```

---

#### `POST /api/voeux/soumettre`
**Description:** Soumission des 5 vÅ“ux d'un Ã©lÃ¨ve

**Request Body:**
```json
{
  "eleveId": 1,
  "conferenceVoeu1": 5,
  "conferenceVoeu2": 12,
  "activiteVoeu3": 8,
  "activiteVoeu4": 23,
  "activiteVoeu5": 27
}
```

**Validations cÃ´tÃ© serveur:**
1. Ã‰lÃ¨ve existe et n'a pas dÃ©jÃ  soumis
2. VÅ“ux 1-2 sont des CONFERENCE diffÃ©rentes
3. VÅ“ux 3-4-5 sont diffÃ©rents entre eux
4. Pas de doublons entre vÅ“ux 1-2 et 3-4-5
5. Toutes les activitÃ©s sont de la mÃªme demi-journÃ©e que l'Ã©lÃ¨ve

**Response (200 OK):**
```json
{
  "message": "VÅ“ux enregistrÃ©s avec succÃ¨s",
  "eleveId": 1,
  "nombreVoeux": 5,
  "dateSoumission": "2025-11-08T14:35:00"
}
```

**Errors:**
- `400` : Validation Ã©chouÃ©e (doublons, types invalides, etc.)
- `404` : Ã‰lÃ¨ve ou activitÃ© introuvable
- `409` : Ã‰lÃ¨ve a dÃ©jÃ  soumis ses vÅ“ux

---

#### `GET /api/voeux/status/{eleveId}`
**Description:** VÃ©rifier si un Ã©lÃ¨ve a dÃ©jÃ  soumis ses vÅ“ux

**Response (200 OK):**
```json
true
```

---

#### `GET /api/voeux/mon-ticket?eleveId={id}&nom={nom}`
**Description:** TÃ©lÃ©chargement du ticket PDF par l'Ã©lÃ¨ve (authentification ID + Nom)

**Query Parameters:**
- `eleveId` : ID de l'Ã©lÃ¨ve
- `nom` : Nom de l'Ã©lÃ¨ve (vÃ©rifiÃ©)

**Response (200 OK):**
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename="planning_jean_dupont.pdf"`
- Body: Binary PDF

**Errors:**
- `404` : Ã‰lÃ¨ve introuvable ou ticket non gÃ©nÃ©rÃ©
- `401` : Nom incorrect
- `409` : Ticket pas encore disponible

---

#### `GET /api/voeux/mon-ticket/status?eleveId={id}&nom={nom}`
**Description:** VÃ©rifier si le ticket PDF est disponible

**Response (200 OK):**
```json
{
  "disponible": true
}
```

---

### ğŸ”§ **CatÃ©gorie 3 : Administration - Configuration**

**Tous les endpoints ci-dessous nÃ©cessitent `Authorization: Bearer {token}` et rÃ´le `ADMIN`**

#### `GET /api/admin/lycees`
**Description:** Liste de tous les lycÃ©es

**Response (200 OK):**
```json
[
  {
    "id": 1,
    "nom": "LycÃ©e Victor Hugo",
    "ville": "Paris",
    "codePostal": "75001"
  }
]
```

---

#### `POST /api/admin/lycees`
**Description:** CrÃ©er un nouveau lycÃ©e

**Request Body:**
```json
{
  "nom": "LycÃ©e MoliÃ¨re",
  "ville": "Lyon",
  "codePostal": "69000"
}
```

**Response (201 Created):**
```json
{
  "id": 2,
  "nom": "LycÃ©e MoliÃ¨re",
  "ville": "Lyon",
  "codePostal": "69000"
}
```

---

#### `PUT /api/admin/lycees/{id}`
**Description:** Modifier un lycÃ©e

---

#### `DELETE /api/admin/lycees/{id}`
**Description:** Supprimer un lycÃ©e (si aucun Ã©lÃ¨ve n'y est rattachÃ©)

---

#### `GET /api/admin/eleves`
**Description:** Liste de tous les Ã©lÃ¨ves

**Response (200 OK):**
```json
[
  {
    "id": 1,
    "nom": "DUPONT",
    "prenom": "Jean",
    "lyceeId": 1,
    "lyceeNom": "LycÃ©e Victor Hugo",
    "demiJournee": "MATIN",
    "voeuxSoumis": true,
    "dateSoumission": "2025-11-08T14:35:00"
  }
]
```

---

#### `POST /api/admin/eleves`
**Description:** CrÃ©er un nouvel Ã©lÃ¨ve

**Request Body:**
```json
{
  "nom": "MARTIN",
  "prenom": "Sophie",
  "lyceeId": 1,
  "demiJournee": "APRES_MIDI"
}
```

---

#### `POST /api/admin/eleves/import-csv`
**Description:** Import CSV d'Ã©lÃ¨ves en masse

**Request:** `multipart/form-data`
- `file`: fichier CSV (colonnes: nom, prenom, lyceeId, demiJournee)

**Response (200 OK):**
```json
{
  "totalLignes": 50,
  "importsReussis": 48,
  "erreurs": [
    {
      "ligne": 23,
      "message": "LycÃ©e introuvable"
    }
  ]
}
```

---

#### `GET /api/admin/activites`
**Description:** Liste de toutes les activitÃ©s

---

#### `POST /api/admin/activites`
**Description:** CrÃ©er une nouvelle activitÃ©

**Request Body:**
```json
{
  "titre": "Blockchain et Cryptomonnaies",
  "description": "Introduction aux technologies blockchain",
  "type": "CONFERENCE",
  "demiJournee": "MATIN",
  "capaciteMax": 30
}
```

---

#### `POST /api/admin/activites/import-csv`
**Description:** Import CSV d'activitÃ©s en masse

---

#### `GET /api/admin/salles`
**Description:** Liste de toutes les salles

---

#### `POST /api/admin/salles`
**Description:** CrÃ©er une nouvelle salle

**Request Body:**
```json
{
  "nom": "AmphithÃ©Ã¢tre A",
  "capacite": 150,
  "batiment": "BÃ¢timent Principal",
  "equipements": "VidÃ©oprojecteur 4K, Sono, Micro HF"
}
```

---

#### `POST /api/admin/salles/import-csv`
**Description:** Import CSV de salles en masse

---

#### `GET /api/admin/creneaux`
**Description:** Liste de tous les crÃ©neaux horaires

---

#### `POST /api/admin/creneaux`
**Description:** CrÃ©er un nouveau crÃ©neau

**Request Body:**
```json
{
  "heureDebut": "09:00",
  "heureFin": "10:30",
  "demiJournee": "MATIN"
}
```

---

### ğŸ¯ **CatÃ©gorie 4 : Administration - Sessions**

#### `POST /api/admin/sessions/generation/auto`
**Description:** GÃ©nÃ©ration automatique des sessions (crÃ©e des instances d'activitÃ©s dans salles/crÃ©neaux)

**Logique:**
1. Pour chaque activitÃ© ayant des vÅ“ux
2. Calculer le nombre de sessions nÃ©cessaires (basÃ© sur capacitÃ© salle vs. nombre de vÅ“ux)
3. Assigner automatiquement une salle et un crÃ©neau
4. CrÃ©er les entitÃ©s Session

**Response (200 OK):**
```json
{
  "message": "Sessions gÃ©nÃ©rÃ©es avec succÃ¨s",
  "totalActivites": 28,
  "sessionsCrees": 45,
  "details": {
    "MATIN": {
      "CONFERENCE": 12,
      "TABLE_RONDE": 3,
      "FLASH_METIER": 5
    },
    "APRES_MIDI": { ... }
  }
}
```

**Errors:**
- `409` : Aucune salle ou crÃ©neau disponible
- `400` : Aucun vÅ“u soumis

---

#### `GET /api/admin/sessions`
**Description:** Liste de toutes les sessions crÃ©Ã©es

**Response (200 OK):**
```json
[
  {
    "id": 1,
    "activiteTitre": "Intelligence Artificielle et Machine Learning",
    "activiteType": "CONFERENCE",
    "salleNom": "AmphithÃ©Ã¢tre A",
    "creneauDebut": "09:00",
    "creneauFin": "10:30",
    "demiJournee": "MATIN",
    "capaciteEffective": 30,
    "nombreAffectations": 0
  }
]
```

---

#### `DELETE /api/admin/sessions/{id}`
**Description:** Supprimer une session (uniquement si aucune affectation)

---

### ğŸš€ **CatÃ©gorie 5 : Algorithme d'Affectation (Timefold)**

#### `POST /api/admin/affectations/lancer`
**Description:** Lance l'algorithme d'optimisation Timefold (asynchrone)

**Logique:**
1. Charger tous les Ã©lÃ¨ves avec leurs vÅ“ux
2. Charger toutes les sessions disponibles
3. CrÃ©er un problÃ¨me Timefold (contraintes hard/soft)
4. RÃ©soudre pendant 30 secondes
5. Sauvegarder les affectations en BDD

**Contraintes Hard (ne peuvent pas Ãªtre violÃ©es):**
- Un Ã©lÃ¨ve ne peut pas Ãªtre affectÃ© 2 fois au mÃªme crÃ©neau
- CapacitÃ© des sessions respectÃ©e
- Demi-journÃ©e respectÃ©e

**Contraintes Soft (Ã  maximiser):**
- PrioritÃ© des vÅ“ux (vÅ“u 1 > vÅ“u 2 > vÅ“u 3 ...)
- Satisfaction globale

**Response (202 Accepted):**
```json
{
  "problemId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "status": "STARTED",
  "message": "Algorithme lancÃ© avec succÃ¨s"
}
```

---

#### `GET /api/admin/affectations/status`
**Description:** RÃ©cupÃ©rer le statut de l'algorithme

**Response (200 OK) - En cours:**
```json
{
  "running": true,
  "hasExistingResults": false
}
```

**Response (200 OK) - TerminÃ©:**
```json
{
  "running": false,
  "hasExistingResults": true
}
```

---

#### `GET /api/admin/affectations/resultats`
**Description:** RÃ©cupÃ©rer les rÃ©sultats de l'affectation

**Response (200 OK):**
```json
{
  "status": "COMPLETED",
  "score": "0hard/-1250soft",
  "hardScore": 0,
  "softScore": -1250,
  "affectations": [
    {
      "id": 1,
      "eleveId": 1,
      "eleveNom": "DUPONT Jean",
      "lycee": "LycÃ©e Victor Hugo",
      "activiteTitre": "Intelligence Artificielle et Machine Learning",
      "activiteType": "CONFERENCE",
      "salleNom": "AmphithÃ©Ã¢tre A",
      "creneauDebut": "09:00",
      "creneauFin": "10:30",
      "demiJournee": "MATIN",
      "priorite": 1,
      "scoreAffectation": -1
    }
  ]
}
```

**InterprÃ©tation du Score:**
- `0hard` = Toutes les contraintes hard respectÃ©es âœ…
- `-1250soft` = Score de satisfaction (plus proche de 0 = mieux)

---

#### `GET /api/admin/affectations`
**Description:** Liste de toutes les affectations sauvegardÃ©es (alternative Ã  `/resultats`)

---

#### `PUT /api/admin/affectations/{affectationId}`
**Description:** Modifier manuellement une affectation (changer la session)

**Request Body:**
```json
{
  "sessionId": 15
}
```

---

#### `DELETE /api/admin/affectations/all`
**Description:** Supprimer TOUTES les affectations et tickets PDF associÃ©s

**Response (200 OK):**
```json
{
  "message": "Toutes les affectations et tickets PDF ont Ã©tÃ© supprimÃ©s avec succÃ¨s",
  "count": 250
}
```

---

### ğŸ“„ **CatÃ©gorie 6 : GÃ©nÃ©ration de Tickets PDF**

#### `POST /api/admin/tickets/generer-tous`
**Description:** GÃ©nÃ©ration en lot de tous les tickets PDF (asynchrone)

**Logique:**
1. Pour chaque Ã©lÃ¨ve ayant des affectations
2. GÃ©nÃ©rer un PDF avec PDFBox (en-tÃªte, tableau des 5 activitÃ©s)
3. Sauvegarder dans `/app/tickets/2025/eleve_{id}.pdf`
4. CrÃ©er une entrÃ©e `Ticket` en BDD

**Response (202 Accepted):**
```json
{
  "message": "GÃ©nÃ©ration des tickets lancÃ©e en arriÃ¨re-plan",
  "status": "EN_COURS"
}
```

---

#### `POST /api/admin/tickets/eleves/{id}/regenerer`
**Description:** RÃ©gÃ©nÃ©rer le ticket d'un Ã©lÃ¨ve spÃ©cifique

**Response (200 OK):**
```json
{
  "message": "Ticket rÃ©gÃ©nÃ©rÃ© avec succÃ¨s",
  "ticketId": 42,
  "dateGeneration": "2025-11-08T16:20:00"
}
```

---

#### `GET /api/admin/tickets/eleves/{id}/ticket`
**Description:** TÃ©lÃ©charger le ticket PDF d'un Ã©lÃ¨ve (admin)

**Response (200 OK):**
- Content-Type: `application/pdf`
- Body: Binary PDF

---

### ğŸ” **CatÃ©gorie 7 : Super Admin**

**Tous les endpoints ci-dessous nÃ©cessitent rÃ´le `SUPERADMIN`**

#### `DELETE /api/superadmin/system/purge-all`
**Description:** Suppression complÃ¨te de TOUTES les donnÃ©es (sauf admins)

**Ordre de suppression (respecte les FK):**
1. Affectations
2. VÅ“ux
3. Sessions
4. Tickets
5. Ã‰lÃ¨ves
6. ActivitÃ©s
7. Salles
8. CrÃ©neaux
9. LycÃ©es

**Response (200 OK):**
```json
{
  "message": "Toutes les donnÃ©es ont Ã©tÃ© supprimÃ©es avec succÃ¨s",
  "details": {
    "affectations": 250,
    "voeux": 250,
    "sessions": 45,
    "tickets": 50,
    "eleves": 50,
    "activites": 28,
    "salles": 10,
    "creneaux": 6,
    "lycees": 3
  }
}
```

---

#### `GET /api/superadmin/system/stats`
**Description:** Statistiques systÃ¨me globales

**Response (200 OK):**
```json
{
  "eleves": 50,
  "activites": 28,
  "salles": 10,
  "creneaux": 6,
  "lycees": 3,
  "voeuxSoumis": 250,
  "affectations": 250,
  "sessions": 45,
  "tickets": 50
}
```

---

## Services et Logique MÃ©tier

### 1. **VoeuxService**

**ResponsabilitÃ©:** Validation complexe des vÅ“ux Ã©lÃ¨ves

**MÃ©thode principale: `soumettreVoeux()`**

```java
@Transactional
public VoeuxSubmissionResponseDTO soumettreVoeux(VoeuxSubmissionDTO submission) {
    // 1. VÃ©rifier que l'Ã©lÃ¨ve existe
    Eleve eleve = eleveRepository.findById(submission.getEleveId())
        .orElseThrow(() -> new ValidationException("Ã‰lÃ¨ve introuvable"));
    
    // 2. VÃ©rifier que l'Ã©lÃ¨ve n'a pas dÃ©jÃ  soumis
    if (eleve.getVoeuxSoumis()) {
        throw new ValidationException("VÅ“ux dÃ©jÃ  soumis");
    }
    
    // 3. Charger toutes les activitÃ©s sÃ©lectionnÃ©es
    Map<Long, Activite> activitesMap = new HashMap<>();
    activitesMap.put(submission.getConferenceVoeu1(), ...);
    // ...
    
    // 4. VALIDATIONS COMPLEXES
    // 4a. VÅ“ux 1-2 : doivent Ãªtre des CONFERENCE diffÃ©rentes
    if (activitesMap.get(conf1).getType() != TypeActivite.CONFERENCE) {
        throw new ValidationException("VÅ“u 1 doit Ãªtre une confÃ©rence");
    }
    if (conf1.equals(conf2)) {
        throw new ValidationException("VÅ“ux 1 et 2 doivent Ãªtre diffÃ©rents");
    }
    
    // 4b. VÅ“ux 3-4-5 : pas de doublons entre eux
    Set<Long> voeux345 = new HashSet<>();
    voeux345.add(submission.getActiviteVoeu3());
    voeux345.add(submission.getActiviteVoeu4());
    voeux345.add(submission.getActiviteVoeu5());
    if (voeux345.size() != 3) {
        throw new ValidationException("VÅ“ux 3-4-5 doivent Ãªtre diffÃ©rents");
    }
    
    // 4c. Pas de doublons entre vÅ“ux 1-2 et 3-4-5
    if (voeux345.contains(conf1) || voeux345.contains(conf2)) {
        throw new ValidationException("Pas de doublons entre vÅ“ux 1-2 et 3-4-5");
    }
    
    // 4d. Toutes les activitÃ©s sont de la mÃªme demi-journÃ©e
    DemiJournee demiJourneeEleve = eleve.getDemiJournee();
    for (Activite activite : activitesMap.values()) {
        if (activite.getDemiJournee() != demiJourneeEleve) {
            throw new ValidationException("Demi-journÃ©e incorrecte");
        }
    }
    
    // 5. ENREGISTREMENT DES VÅ’UX
    List<Voeu> voeux = new ArrayList<>();
    voeux.add(creerVoeu(eleve, conf1, 1, TypeVoeu.VOEU_1_2));
    voeux.add(creerVoeu(eleve, conf2, 2, TypeVoeu.VOEU_1_2));
    voeux.add(creerVoeu(eleve, act3, 3, TypeVoeu.VOEU_3_4_5));
    voeux.add(creerVoeu(eleve, act4, 4, TypeVoeu.VOEU_3_4_5));
    voeux.add(creerVoeu(eleve, act5, 5, TypeVoeu.VOEU_3_4_5));
    
    voeuRepository.saveAll(voeux);
    
    // 6. Marquer l'Ã©lÃ¨ve comme ayant soumis
    eleve.setVoeuxSoumis(true);
    eleve.setDateSoumission(LocalDateTime.now());
    eleveRepository.save(eleve);
    
    return new VoeuxSubmissionResponseDTO(...);
}
```

---

### 2. **AffectationService**

**ResponsabilitÃ©:** Orchestration de l'algorithme Timefold

**MÃ©thode principale: `lancerAffectation()`**

```java
@Transactional(readOnly = true)
public UUID lancerAffectation() {
    // 1. Charger les donnÃ©es avec EAGER LOADING
    List<Eleve> eleves = eleveRepository.findAllWithLycee();
    List<Session> sessions = sessionRepository.findAllWithDetails();
    List<Voeu> voeux = voeuRepository.findAllWithDetails();
    
    // 2. Validation : au moins 1 session existe
    if (sessions.isEmpty()) {
        throw new IllegalStateException("Aucune session crÃ©Ã©e");
    }
    
    // 3. CrÃ©er les Affectations initiales (non assignÃ©es)
    List<Affectation> affectations = new ArrayList<>();
    for (Eleve eleve : eleves) {
        List<Voeu> voeuxEleve = voeux.stream()
            .filter(v -> v.getEleve().getId().equals(eleve.getId()))
            .sorted(Comparator.comparing(Voeu::getOrdre))
            .collect(Collectors.toList());
        
        for (Voeu voeu : voeuxEleve) {
            Affectation aff = new Affectation();
            aff.setEleve(eleve);
            aff.setActivite(voeu.getActivite());
            aff.setPriorite(voeu.getOrdre());
            aff.setTypeVoeu(voeu.getTypeVoeu());
            // assignedSession = null (sera rempli par Timefold)
            affectations.add(aff);
        }
    }
    
    // 4. CrÃ©er le problÃ¨me Timefold
    AffectationSolution problem = new AffectationSolution();
    problem.setEleves(eleves);
    problem.setSessions(sessions);
    problem.setAffectations(affectations);
    
    // 5. Configurer le solver
    SolverFactory<AffectationSolution> solverFactory = 
        SolverFactory.create(new SolverConfig()
            .withSolutionClass(AffectationSolution.class)
            .withEntityClasses(Affectation.class)
            .withConstraintProviderClass(AffectationConstraintProvider.class)
            .withTerminationSpentLimit(Duration.ofSeconds(30))
        );
    
    // 6. RÃ©soudre (bloquant pendant 30s)
    Solver<AffectationSolution> solver = solverFactory.buildSolver();
    AffectationSolution solution = solver.solve(problem);
    
    // 7. Sauvegarder les rÃ©sultats
    this.lastSolution = solution;
    sauvegarderAffectations(solution.getAffectations());
    
    return UUID.randomUUID();
}
```

**Contraintes Timefold (dans `AffectationConstraintProvider`):**

```java
@ConstraintConfiguration
public class AffectationConstraintProvider implements ConstraintProvider {
    
    @Override
    public Constraint[] defineConstraints(ConstraintFactory factory) {
        return new Constraint[] {
            // HARD CONSTRAINTS
            conflitCreneau(factory),
            capaciteSalleRespectee(factory),
            demiJourneeRespectee(factory),
            
            // SOFT CONSTRAINTS
            maximiserSatisfactionVoeux(factory)
        };
    }
    
    // Un Ã©lÃ¨ve ne peut pas Ãªtre affectÃ© 2 fois au mÃªme crÃ©neau
    Constraint conflitCreneau(ConstraintFactory factory) {
        return factory.forEach(Affectation.class)
            .join(Affectation.class,
                equal(Affectation::getEleve),
                equal(aff -> aff.getAssignedSession().getCreneau()),
                lessThan(Affectation::getId)
            )
            .penalize(HardSoftScore.ONE_HARD)
            .asConstraint("Conflit crÃ©neau");
    }
    
    // CapacitÃ© des sessions respectÃ©e
    Constraint capaciteSalleRespectee(ConstraintFactory factory) {
        return factory.forEach(Affectation.class)
            .groupBy(Affectation::getAssignedSession, count())
            .filter((session, count) -> count > session.getCapaciteEffective())
            .penalize(HardSoftScore.ONE_HARD)
            .asConstraint("CapacitÃ© salle dÃ©passÃ©e");
    }
    
    // Maximiser la satisfaction (prioritÃ© vÅ“u 1 > 2 > 3 > 4 > 5)
    Constraint maximiserSatisfactionVoeux(ConstraintFactory factory) {
        return factory.forEach(Affectation.class)
            .penalize(HardSoftScore.ONE_SOFT, aff -> aff.getPriorite())
            .asConstraint("Satisfaction vÅ“ux");
    }
}
```

---

### 3. **SessionGenerationService**

**ResponsabilitÃ©:** CrÃ©ation automatique des sessions (avant l'algorithme)

**MÃ©thode principale: `genererSessionsAutomatiquement()`**

```java
@Transactional
public Map<String, Object> genererSessionsAutomatiquement() {
    // 1. RÃ©cupÃ©rer tous les vÅ“ux
    List<Voeu> voeux = voeuRepository.findAll();
    
    // 2. Grouper par activitÃ©
    Map<Activite, List<Voeu>> voeuxParActivite = voeux.stream()
        .collect(Collectors.groupingBy(Voeu::getActivite));
    
    // 3. Pour chaque activitÃ© ayant des vÅ“ux
    int sessionsCrees = 0;
    for (Map.Entry<Activite, List<Voeu>> entry : voeuxParActivite.entrySet()) {
        Activite activite = entry.getKey();
        int nombreVoeux = entry.getValue().size();
        
        // Calculer le nombre de sessions nÃ©cessaires
        int nbSessionsNecessaires = (int) Math.ceil(
            (double) nombreVoeux / activite.getCapaciteMax()
        );
        
        // RÃ©cupÃ©rer les salles/crÃ©neaux disponibles pour cette demi-journÃ©e
        List<Salle> salles = salleRepository.findAll();
        List<Creneau> creneaux = creneauRepository.findByDemiJournee(
            activite.getDemiJournee()
        );
        
        // CrÃ©er les sessions
        for (int i = 0; i < nbSessionsNecessaires; i++) {
            Salle salle = salles.get(i % salles.size()); // Round-robin
            Creneau creneau = creneaux.get(i % creneaux.size());
            
            Session session = new Session();
            session.setActivite(activite);
            session.setSalle(salle);
            session.setCreneau(creneau);
            session.setCapaciteEffective(Math.min(
                activite.getCapaciteMax(),
                salle.getCapacite()
            ));
            
            sessionRepository.save(session);
            sessionsCrees++;
        }
    }
    
    return Map.of(
        "message", "Sessions gÃ©nÃ©rÃ©es avec succÃ¨s",
        "sessionsCrees", sessionsCrees
    );
}
```

---

### 4. **BatchPdfService**

**ResponsabilitÃ©:** GÃ©nÃ©ration en lot des tickets PDF (asynchrone)

**MÃ©thode principale: `genererTousLesTickets()`**

```java
@Async("taskExecutor")
@Transactional
public CompletableFuture<BatchResult> genererTousLesTickets() {
    log.info("ğŸš€ DÃ©but gÃ©nÃ©ration batch tickets...");
    
    BatchResult result = new BatchResult();
    List<Eleve> eleves = eleveRepository.findAll();
    result.setTotalEleves(eleves.size());
    
    for (Eleve eleve : eleves) {
        try {
            // 1. RÃ©cupÃ©rer les affectations de l'Ã©lÃ¨ve
            List<Affectation> affectations = affectationRepository
                .findByEleveAndAssignedSessionIsNotNull(eleve);
            
            if (affectations.isEmpty()) {
                result.incrementErreurs();
                result.addErreur(eleve.getId(), "Aucune affectation");
                continue;
            }
            
            // 2. GÃ©nÃ©rer le PDF avec PDFBox
            byte[] pdfData = pdfGenerationService.genererTicketEleve(
                eleve, affectations
            );
            
            // 3. Sauvegarder sur le file system
            String cheminFichier = storageService.sauvegarderPdf(
                eleve.getId(), pdfData
            );
            
            // 4. Enregistrer en BDD
            Ticket ticket = ticketRepository.findByEleve(eleve)
                .orElse(new Ticket());
            ticket.setEleve(eleve);
            ticket.setCheminFichier(cheminFichier);
            ticket.setDateGeneration(LocalDateTime.now());
            ticket.setTailleFichier((long) pdfData.length);
            ticket.setStatut(StatutTicket.GENERE);
            ticketRepository.save(ticket);
            
            result.incrementSucces();
            
        } catch (Exception e) {
            log.error("Erreur gÃ©nÃ©ration ticket Ã©lÃ¨ve {}", eleve.getId(), e);
            result.incrementErreurs();
            result.addErreur(eleve.getId(), e.getMessage());
        }
    }
    
    log.info("âœ… Batch terminÃ© : {} succÃ¨s, {} erreurs", 
             result.getSucces(), result.getErreurs());
    
    return CompletableFuture.completedFuture(result);
}
```

---

### 5. **PdfGenerationService**

**ResponsabilitÃ©:** GÃ©nÃ©ration du PDF avec PDFBox

**MÃ©thode principale: `genererTicketEleve()`**

```java
public byte[] genererTicketEleve(Eleve eleve, List<Affectation> affectations) 
        throws IOException {
    
    try (PDDocument document = new PDDocument()) {
        PDPage page = new PDPage(PDRectangle.A4);
        document.addPage(page);
        
        try (PDPageContentStream content = new PDPageContentStream(document, page)) {
            float yPosition = page.getMediaBox().getHeight() - MARGIN;
            
            // 1. En-tÃªte du ticket
            yPosition = drawHeader(content, eleve, yPosition);
            
            // 2. Tableau des affectations
            yPosition = drawAffectationsTable(content, affectations, yPosition);
            
            // 3. Pied de page
            drawFooter(content, page);
        }
        
        // Conversion en byte array
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        document.save(baos);
        return baos.toByteArray();
    }
}

private float drawHeader(PDPageContentStream content, Eleve eleve, float yPosition) 
        throws IOException {
    content.setFont(PDType1Font.HELVETICA_BOLD, FONT_SIZE_TITLE);
    content.beginText();
    content.newLineAtOffset(MARGIN, yPosition);
    content.showText("FESUP - Planning PersonnalisÃ©");
    content.endText();
    yPosition -= 30;
    
    content.setFont(PDType1Font.HELVETICA, FONT_SIZE_HEADER);
    content.beginText();
    content.newLineAtOffset(MARGIN, yPosition);
    content.showText("Ã‰lÃ¨ve : " + eleve.getPrenom() + " " + eleve.getNom());
    content.endText();
    yPosition -= 20;
    
    content.beginText();
    content.newLineAtOffset(MARGIN, yPosition);
    content.showText("LycÃ©e : " + eleve.getLycee().getNom());
    content.endText();
    yPosition -= 20;
    
    content.beginText();
    content.newLineAtOffset(MARGIN, yPosition);
    content.showText("Demi-journÃ©e : " + eleve.getDemiJournee());
    content.endText();
    yPosition -= 40;
    
    return yPosition;
}

private float drawAffectationsTable(PDPageContentStream content, 
        List<Affectation> affectations, float yPosition) throws IOException {
    
    // Dessiner les en-tÃªtes de colonnes
    content.setFont(PDType1Font.HELVETICA_BOLD, FONT_SIZE_BODY);
    content.beginText();
    content.newLineAtOffset(MARGIN, yPosition);
    content.showText("PrioritÃ© | ActivitÃ© | Salle | Horaire");
    content.endText();
    yPosition -= 20;
    
    // Dessiner les lignes du tableau
    content.setFont(PDType1Font.HELVETICA, FONT_SIZE_BODY);
    for (Affectation aff : affectations) {
        Session session = aff.getAssignedSession();
        String ligne = String.format("%d | %s | %s | %s-%s",
            aff.getPriorite(),
            aff.getActivite().getTitre(),
            session.getSalle().getNom(),
            session.getCreneau().getHeureDebut(),
            session.getCreneau().getHeureFin()
        );
        
        content.beginText();
        content.newLineAtOffset(MARGIN, yPosition);
        content.showText(ligne);
        content.endText();
        yPosition -= 15;
    }
    
    return yPosition;
}
```

---

### 6. **TicketStorageService**

**ResponsabilitÃ©:** Gestion du stockage des PDF sur le file system

**MÃ©thodes principales:**

```java
@Service
public class TicketStorageService {
    
    @Value("${application.tickets.storage-path:/var/fesup/tickets}")
    private String storagePath;
    
    // Sauvegarder un PDF
    public String sauvegarderPdf(Long eleveId, byte[] pdfData) throws IOException {
        // CrÃ©er l'arborescence : tickets/2025/eleve_123.pdf
        int annee = LocalDateTime.now().getYear();
        Path dossierAnnee = Paths.get(storagePath, String.valueOf(annee));
        
        if (!Files.exists(dossierAnnee)) {
            Files.createDirectories(dossierAnnee);
        }
        
        String nomFichier = String.format("eleve_%d.pdf", eleveId);
        Path cheminComplet = dossierAnnee.resolve(nomFichier);
        
        Files.write(cheminComplet, pdfData, 
                    StandardOpenOption.CREATE, 
                    StandardOpenOption.TRUNCATE_EXISTING);
        
        // Retourner le chemin relatif
        return String.format("%d/%s", annee, nomFichier);
    }
    
    // RÃ©cupÃ©rer un PDF
    public byte[] recupererPdf(String cheminRelatif) throws IOException {
        Path cheminComplet = Paths.get(storagePath, cheminRelatif);
        
        if (!Files.exists(cheminComplet)) {
            throw new FileNotFoundException("Ticket introuvable");
        }
        
        return Files.readAllBytes(cheminComplet);
    }
    
    // Supprimer un PDF
    public void supprimerPdf(String cheminRelatif) throws IOException {
        Path cheminComplet = Paths.get(storagePath, cheminRelatif);
        Files.deleteIfExists(cheminComplet);
    }
    
    // Supprimer tous les PDFs
    public int supprimerTousPdfs() throws IOException {
        Path racine = Paths.get(storagePath);
        AtomicInteger count = new AtomicInteger(0);
        
        Files.walk(racine)
            .filter(Files::isRegularFile)
            .filter(p -> p.toString().endsWith(".pdf"))
            .forEach(p -> {
                try {
                    Files.delete(p);
                    count.incrementAndGet();
                } catch (IOException e) {
                    log.error("Erreur suppression PDF : {}", p, e);
                }
            });
        
        return count.get();
    }
}
```

---

## Frontend - Structure des Composants

### 1. **Architecture Modulaire**

```
frontend/src/app/
â”œâ”€â”€ app.module.ts                     # NgModule principal
â”œâ”€â”€ app-routing.module.ts             # Routing gÃ©nÃ©ral
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ identification/               # Ã‰cran 1 : Saisie ID + Nom
â”‚   â”œâ”€â”€ confirmation-identite/        # Ã‰cran 2 : Confirmation infos
â”‚   â”œâ”€â”€ formulaire-voeux/            # Ã‰cran 3 : Formulaire de vÅ“ux
â”‚   â”œâ”€â”€ recapitulatif-voeux/         # Ã‰cran 3.5 : RÃ©cap avant soumission
â”‚   â”œâ”€â”€ confirmation-soumission/     # Ã‰cran 4 : Confirmation finale + TÃ©lÃ©chargement PDF
â”‚   â”‚
â”‚   â”œâ”€â”€ login/                       # Connexion admin
â”‚   â”œâ”€â”€ admin-dashboard/             # Tableau de bord admin (standalone)
â”‚   â”œâ”€â”€ admin-lycees/                # CRUD LycÃ©es (standalone)
â”‚   â”œâ”€â”€ admin-eleves/                # CRUD Ã‰lÃ¨ves + Import CSV (standalone)
â”‚   â”œâ”€â”€ admin-activites/             # CRUD ActivitÃ©s + Import CSV (standalone)
â”‚   â”œâ”€â”€ admin-salles/                # CRUD Salles + Import CSV (standalone)
â”‚   â”œâ”€â”€ admin-creneaux/              # CRUD CrÃ©neaux (standalone)
â”‚   â”œâ”€â”€ admin-sessions/              # GÃ©nÃ©ration automatique de sessions (standalone)
â”‚   â”œâ”€â”€ resultats-affectation/       # Lancer algo + Visualiser rÃ©sultats (standalone)
â”‚   â””â”€â”€ system-settings/             # SuperAdmin : Purge systÃ¨me (standalone)
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ voeux.service.ts             # HTTP + State management (Ã©lÃ¨ve connectÃ©)
â”‚   â”œâ”€â”€ activite.service.ts          # HTTP pour activitÃ©s Ã©lÃ¨ves
â”‚   â”œâ”€â”€ auth.service.ts              # Authentification admin + JWT
â”‚   â”œâ”€â”€ lycee-admin.service.ts       # CRUD LycÃ©es
â”‚   â”œâ”€â”€ eleve-admin.service.ts       # CRUD Ã‰lÃ¨ves + Import CSV
â”‚   â”œâ”€â”€ activite-admin.service.ts    # CRUD ActivitÃ©s + Import CSV
â”‚   â”œâ”€â”€ salle-admin.service.ts       # CRUD Salles + Import CSV
â”‚   â”œâ”€â”€ creneau-admin.service.ts     # CRUD CrÃ©neaux
â”‚   â”œâ”€â”€ session-admin.service.ts     # GÃ©nÃ©ration sessions
â”‚   â”œâ”€â”€ affectation.service.ts       # Lancer algo + RÃ©sultats
â”‚   â””â”€â”€ system.service.ts            # Purge systÃ¨me
â”‚
â”œâ”€â”€ guards/
â”‚   â”œâ”€â”€ voeux.guard.ts               # Protection routes Ã©lÃ¨ves (vÃ©rifie sessionStorage)
â”‚   â””â”€â”€ auth.guard.ts                # Protection routes admin (vÃ©rifie JWT)
â”‚
â”œâ”€â”€ interceptors/
â”‚   â””â”€â”€ auth.interceptor.ts          # Injection automatique du JWT dans les requÃªtes
â”‚
â””â”€â”€ models/
    â”œâ”€â”€ eleve.model.ts               # Interfaces Eleve, AuthRequest, AuthResponse
    â”œâ”€â”€ activite.model.ts            # Interfaces Activite, ActivitesGroupees
    â”œâ”€â”€ voeu.model.ts                # Interfaces VoeuxSubmission, VoeuxResponse
    â”œâ”€â”€ affectation.model.ts         # Interfaces AffectationDTO, AffectationResultat
    â””â”€â”€ admin.model.ts               # Interfaces Lycee, Salle, Creneau, Session, etc.
```

---

### 2. **Composants Principaux**

#### **IdentificationComponent**
- **Route:** `/voeux/identification`
- **ResponsabilitÃ©:** Formulaire de saisie ID + Nom
- **Services utilisÃ©s:** `VoeuxService`
- **Navigation:** â†’ `ConfirmationIdentiteComponent`

---

#### **ConfirmationIdentiteComponent**
- **Route:** `/voeux/confirmation-identite`
- **ResponsabilitÃ©:** Afficher les infos Ã©lÃ¨ve + Bouton "C'est bien moi"
- **Guard:** `VoeuxGuard` (vÃ©rifie que l'Ã©lÃ¨ve est en session)
- **Navigation:** â†’ `FormulaireVoeuxComponent`

---

#### **FormulaireVoeuxComponent**
- **Route:** `/voeux/formulaire`
- **ResponsabilitÃ©:** SÃ©lection des 5 vÅ“ux (avec validations cÃ´tÃ© client)
- **Logique complexe:**
  1. Charger les activitÃ©s via `VoeuxService.getActivites()`
  2. Grouper par type (conferences, tablesRondes, flashsMetiers)
  3. Valider en temps rÃ©el :
     - VÅ“ux 1-2 diffÃ©rents
     - VÅ“ux 3-4-5 diffÃ©rents entre eux
     - Pas de doublons entre 1-2 et 3-4-5
- **Navigation:** â†’ `RecapitulatifVoeuxComponent`

---

#### **RecapitulatifVoeuxComponent**
- **Route:** `/voeux/recapitulatif`
- **ResponsabilitÃ©:** Afficher les 5 vÅ“ux avant soumission finale
- **Action:** Appel Ã  `VoeuxService.soumettreVoeux()`
- **Navigation:** â†’ `ConfirmationSoumissionComponent`

---

#### **ConfirmationSoumissionComponent**
- **Route:** `/voeux/confirmation`
- **ResponsabilitÃ©:** Message de succÃ¨s + TÃ©lÃ©chargement du ticket PDF (si disponible)
- **Logique:**
  1. VÃ©rifier la disponibilitÃ© du ticket via `VoeuxService.verifierDisponibiliteTicket()`
  2. Si disponible, afficher bouton "TÃ©lÃ©charger mon planning"
  3. Appel Ã  `VoeuxService.telechargerMonPlanning()`

---

#### **AdminDashboardComponent** (Standalone)
- **Route:** `/admin/dashboard`
- **Guard:** `AuthGuard`
- **ResponsabilitÃ©:** Tableau de bord avec cartes de navigation vers :
  - Gestion LycÃ©es
  - Gestion Ã‰lÃ¨ves
  - Gestion ActivitÃ©s
  - Gestion Salles
  - Gestion CrÃ©neaux
  - GÃ©nÃ©ration Sessions
  - Affectations (Lancer algo)
  - ParamÃ¨tres SystÃ¨me (SuperAdmin)

---

#### **ResultatsAffectationComponent** (Standalone)
- **Route:** `/admin/affectations`
- **ResponsabilitÃ©:** Lancer l'algorithme + Visualiser les rÃ©sultats
- **Logique:**
  1. Bouton "Lancer l'algorithme" â†’ `AffectationService.lancerAffectation()`
  2. Polling du statut toutes les 2s via `AffectationService.getStatus()`
  3. Affichage des rÃ©sultats via `AffectationService.getResultats()`
  4. Tableau interactif avec possibilitÃ© de modifier une affectation
  5. Boutons :
     - "GÃ©nÃ©rer tous les tickets PDF" â†’ `AffectationService.genererTousLesTickets()`
     - "Supprimer tout" â†’ `AffectationService.deleteAll()`
- **Statistiques affichÃ©es:**
  - Score Hard/Soft
  - Taux de satisfaction global
  - Nombre d'affectations
  - RÃ©partition par type d'activitÃ©

---

### 3. **Services Frontend**

#### **VoeuxService**
```typescript
@Injectable({ providedIn: 'root' })
export class VoeuxService {
  private readonly API_URL = '/api/voeux';
  private eleveConnecte$ = new BehaviorSubject<Eleve | null>(null);
  
  constructor(private http: HttpClient) {
    // Charger l'Ã©lÃ¨ve depuis sessionStorage au dÃ©marrage
    const stored = sessionStorage.getItem('eleveConnecte');
    if (stored) {
      this.eleveConnecte$.next(JSON.parse(stored));
    }
  }
  
  // Authentification Ã©lÃ¨ve (ID + Nom)
  authentifier(eleveId: number, nom: string): Observable<Eleve> {
    return this.http.post<Eleve>(`${this.API_URL}/auth`, { eleveId, nom })
      .pipe(
        tap(eleve => {
          sessionStorage.setItem('eleveConnecte', JSON.stringify(eleve));
          this.eleveConnecte$.next(eleve);
        })
      );
  }
  
  // RÃ©cupÃ©rer les activitÃ©s filtrÃ©es par demi-journÃ©e
  getActivites(demiJournee: string): Observable<ActivitesGroupees> {
    return this.http.get<ActivitesGroupees>(
      `${this.API_URL}/activites/${demiJournee}`
    );
  }
  
  // Soumettre les vÅ“ux
  soumettreVoeux(submission: VoeuxSubmission): Observable<VoeuxResponse> {
    return this.http.post<VoeuxResponse>(
      `${this.API_URL}/soumettre`,
      submission
    );
  }
  
  // VÃ©rifier si le ticket est disponible
  verifierDisponibiliteTicket(eleveId: number, nom: string): Observable<boolean> {
    return this.http.get<{ disponible: boolean }>(
      `${this.API_URL}/mon-ticket/status`,
      { params: { eleveId: eleveId.toString(), nom } }
    ).pipe(map(response => response.disponible));
  }
  
  // TÃ©lÃ©charger le ticket PDF
  telechargerMonPlanning(eleveId: number, nom: string): Observable<Blob> {
    return this.http.get(
      `${this.API_URL}/mon-ticket`,
      {
        params: { eleveId: eleveId.toString(), nom },
        responseType: 'blob'
      }
    );
  }
  
  // DÃ©connexion
  deconnecter(): void {
    sessionStorage.removeItem('eleveConnecte');
    this.eleveConnecte$.next(null);
  }
  
  // Observable pour les composants
  getEleveConnecte(): Observable<Eleve | null> {
    return this.eleveConnecte$.asObservable();
  }
}
```

---

#### **AuthService**
```typescript
@Injectable({ providedIn: 'root' })
export class AuthService {
  private readonly API_URL = '/api/auth';
  private currentUser$ = new BehaviorSubject<User | null>(null);
  
  constructor(private http: HttpClient, private router: Router) {
    // Charger le token depuis localStorage au dÃ©marrage
    const token = localStorage.getItem('jwt_token');
    if (token) {
      const user = this.decodeToken(token);
      this.currentUser$.next(user);
    }
  }
  
  // Connexion admin
  login(email: string, password: string): Observable<AuthResponse> {
    return this.http.post<AuthResponse>(`${this.API_URL}/login`, { email, password })
      .pipe(
        tap(response => {
          localStorage.setItem('jwt_token', response.token);
          this.currentUser$.next({
            email: response.email,
            nom: response.nom,
            prenom: response.prenom,
            role: response.role
          });
        })
      );
  }
  
  // DÃ©connexion
  logout(): void {
    localStorage.removeItem('jwt_token');
    this.currentUser$.next(null);
    this.router.navigate(['/login']);
  }
  
  // RÃ©cupÃ©rer le token
  getToken(): string | null {
    return localStorage.getItem('jwt_token');
  }
  
  // VÃ©rifier si l'utilisateur est connectÃ©
  isAuthenticated(): boolean {
    return !!this.getToken();
  }
  
  // VÃ©rifier le rÃ´le
  hasRole(role: string): boolean {
    const user = this.currentUser$.value;
    return user?.role === role;
  }
  
  // Observable pour les composants
  getCurrentUser(): Observable<User | null> {
    return this.currentUser$.asObservable();
  }
  
  // DÃ©coder le JWT (simplifiÃ©)
  private decodeToken(token: string): User {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return {
      email: payload.sub,
      nom: payload.nom,
      prenom: payload.prenom,
      role: payload.role
    };
  }
}
```

---

#### **AffectationService**
```typescript
@Injectable({ providedIn: 'root' })
export class AffectationService {
  private readonly API_URL = '/api/admin/affectations';
  
  constructor(private http: HttpClient) {}
  
  // Lancer l'algorithme
  lancerAffectation(): Observable<{ problemId: string; status: string }> {
    return this.http.post<any>(`${this.API_URL}/lancer`, {});
  }
  
  // RÃ©cupÃ©rer le statut de l'algorithme
  getStatus(): Observable<{ running: boolean; hasExistingResults: boolean }> {
    return this.http.get<any>(`${this.API_URL}/status`);
  }
  
  // RÃ©cupÃ©rer les rÃ©sultats
  getResultats(): Observable<AffectationResultat> {
    return this.http.get<AffectationResultat>(`${this.API_URL}/resultats`);
  }
  
  // Modifier une affectation
  modifierAffectation(affectationId: number, sessionId: number): Observable<void> {
    return this.http.put<void>(
      `${this.API_URL}/${affectationId}`,
      { sessionId }
    );
  }
  
  // Supprimer toutes les affectations
  deleteAll(): Observable<{ message: string; count: number }> {
    return this.http.delete<any>(`${this.API_URL}/all`);
  }
  
  // GÃ©nÃ©rer tous les tickets PDF
  genererTousLesTickets(): Observable<{ message: string; status: string }> {
    return this.http.post<any>('/api/admin/tickets/generer-tous', {});
  }
}
```

---

### 4. **Guards & Interceptors**

#### **VoeuxGuard**
```typescript
@Injectable({ providedIn: 'root' })
export class VoeuxGuard implements CanActivate {
  constructor(private voeuxService: VoeuxService, private router: Router) {}
  
  canActivate(): boolean {
    const eleve = sessionStorage.getItem('eleveConnecte');
    
    if (!eleve) {
      this.router.navigate(['/voeux/identification']);
      return false;
    }
    
    return true;
  }
}
```

---

#### **AuthGuard**
```typescript
@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(private authService: AuthService, private router: Router) {}
  
  canActivate(route: ActivatedRouteSnapshot): boolean {
    if (!this.authService.isAuthenticated()) {
      this.router.navigate(['/login']);
      return false;
    }
    
    // VÃ©rifier le rÃ´le si nÃ©cessaire
    const requiredRole = route.data['role'];
    if (requiredRole && !this.authService.hasRole(requiredRole)) {
      alert('AccÃ¨s refusÃ© : privilÃ¨ges insuffisants');
      return false;
    }
    
    return true;
  }
}
```

---

#### **AuthInterceptor**
```typescript
@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  constructor(private authService: AuthService) {}
  
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    // Ignorer les endpoints publics
    if (req.url.includes('/api/voeux') || req.url.includes('/api/auth/login')) {
      return next.handle(req);
    }
    
    // Ajouter le JWT aux requÃªtes admin
    const token = this.authService.getToken();
    if (token) {
      const cloned = req.clone({
        headers: req.headers.set('Authorization', `Bearer ${token}`)
      });
      return next.handle(cloned);
    }
    
    return next.handle(req);
  }
}
```

---

## DÃ©ploiement

### PrÃ©requis

- **Docker** : Version 20.10+
- **Docker Compose** : Version 2.0+
- **OS** : Linux, macOS, Windows (avec WSL2)

---

### Ã‰tapes d'installation

#### 1. **Cloner le projet**

```bash
git clone https://github.com/votre-org/fesup.git
cd fesup
```

---

#### 2. **Configuration des variables d'environnement**

CrÃ©er un fichier `.env` Ã  la racine :

```env
# Database
POSTGRES_USER=fesup_user
POSTGRES_PASSWORD=fesup_password
POSTGRES_DB=fesup_db

# Backend
SPRING_PROFILES_ACTIVE=prod
JWT_SECRET=votre_secret_jwt_super_securise_changez_moi

# Frontend
FRONTEND_URL=http://localhost
BACKEND_URL=http://localhost:8080
```

---

#### 3. **Lancer l'application**

```bash
chmod +x start.sh
./start.sh
```

Le script start.sh fait :
1. `docker-compose down -v` (nettoyage)
2. `docker-compose build --no-cache` (rebuild images)
3. `docker-compose up -d` (dÃ©marrage)
4. Attendre que les services soient prÃªts (health checks)

---

#### 4. **VÃ©rifier l'Ã©tat des conteneurs**

```bash
docker-compose ps
```

**Sortie attendue :**

```
NAME                   STATUS              PORTS
fesup-db-1            Up (healthy)        5432/tcp, 0.0.0.0:5434->5432/tcp
fesup-backend-1       Up (healthy)        0.0.0.0:8080->8080/tcp
fesup-frontend-1      Up (healthy)        0.0.0.0:80->80/tcp
```

---

#### 5. **AccÃ¨s aux services**

| Service | URL | Credentials |
|---------|-----|-------------|
| **Frontend (Ã©lÃ¨ves)** | http://localhost | - |
| **Frontend (admin)** | http://localhost/admin | admin@fesup.fr / admin123 |
| **Backend API** | http://localhost:8080/api | - |
| **PostgreSQL** | localhost:5434 | fesup_user / fesup_password |
| **PgAdmin** | http://localhost:5050 | admin@fesup.fr / admin |

---

### Commandes utiles

#### ArrÃªter les services

```bash
docker-compose down
```

#### ArrÃªter et supprimer les volumes (BDD + PDFs)

```bash
docker-compose down -v
```

#### Voir les logs en temps rÃ©el

```bash
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f db
```

#### RedÃ©marrer un service spÃ©cifique

```bash
docker-compose restart backend
```

#### ExÃ©cuter une commande dans un conteneur

```bash
docker-compose exec backend bash
docker-compose exec db psql -U fesup_user -d fesup_db
```

---

### Structure Docker Compose

```yaml
version: '3.8'

services:
  db:
    image: postgres:16-alpine
    container_name: fesup-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - fesup-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fesup-backend
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - tickets_storage:/app/tickets
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - fesup-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: fesup-frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - fesup-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  fesup-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  tickets_storage:
    driver: local
```

---

## SÃ©curitÃ©

### 1. **Authentification**

#### Ã‰lÃ¨ves (Public)
- **MÃ©thode** : Identification par ID + Nom (case-insensitive)
- **Session** : `sessionStorage` cÃ´tÃ© frontend
- **Protection** : `VoeuxGuard` (empÃªche l'accÃ¨s sans identification)

#### Administrateurs
- **MÃ©thode** : JWT (JSON Web Token)
- **GÃ©nÃ©ration** : `/api/auth/login` avec BCrypt password
- **DurÃ©e de validitÃ©** : 24 heures (configurable dans `application.properties`)
- **Storage** : `localStorage` cÃ´tÃ© frontend
- **Protection** : `AuthGuard` + `@PreAuthorize("hasRole('ADMIN')")` cÃ´tÃ© backend

---

### 2. **Hachage des mots de passe**

```java
@Configuration
public class SecurityConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12); // CoÃ»t 12
    }
}
```

**Exemple d'enregistrement d'un admin :**

```java
User admin = new User();
admin.setEmail("admin@fesup.fr");
admin.setPassword(passwordEncoder.encode("admin123"));
admin.setRole(Role.ADMIN);
userRepository.save(admin);
```

---

### 3. **Protection CORS**

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
            .allowedOrigins("http://localhost", "http://localhost:80")
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .maxAge(3600);
    }
}
```

---

### 4. **Validation des entrÃ©es**

#### Backend (Spring Validation)

```java
@PostMapping("/soumettre")
public ResponseEntity<VoeuxResponseDTO> soumettre(
    @Valid @RequestBody VoeuxSubmissionDTO submission
) {
    // @Valid dÃ©clenche les validations
}

// DTO avec annotations
public class VoeuxSubmissionDTO {
    @NotNull(message = "L'ID de l'Ã©lÃ¨ve est obligatoire")
    private Long eleveId;
    
    @NotNull(message = "Le vÅ“u 1 est obligatoire")
    private Long conferenceVoeu1;
    
    // ...
}
```

#### Frontend (Angular Reactive Forms)

```typescript
this.formulaireVoeux = this.fb.group({
  conferenceVoeu1: [null, Validators.required],
  conferenceVoeu2: [null, Validators.required],
  activiteVoeu3: [null, Validators.required],
  activiteVoeu4: [null, Validators.required],
  activiteVoeu5: [null, Validators.required]
}, {
  validators: [
    this.voeuxDifferentsValidator(),
    this.pasDeDoublonsValidator()
  ]
});
```

---

### 5. **Gestion des erreurs**

#### Global Exception Handler (Backend)

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidation(ValidationException ex) {
        return ResponseEntity
            .status(HttpStatus.BAD_REQUEST)
            .body(new ErrorResponse(ex.getMessage()));
    }
    
    @ExceptionHandler(EntityNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFound(EntityNotFoundException ex) {
        return ResponseEntity
            .status(HttpStatus.NOT_FOUND)
            .body(new ErrorResponse(ex.getMessage()));
    }
    
    @ExceptionHandler(UnauthorizedException.class)
    public ResponseEntity<ErrorResponse> handleUnauthorized(UnauthorizedException ex) {
        return ResponseEntity
            .status(HttpStatus.UNAUTHORIZED)
            .body(new ErrorResponse(ex.getMessage()));
    }
}
```

---

### 6. **Transactions**

Toutes les opÃ©rations critiques sont dans des transactions :

```java
@Transactional
public void soumettreVoeux(VoeuxSubmissionDTO submission) {
    // Si une exception est levÃ©e, rollback automatique
}
```

---

### 7. **Isolation des donnÃ©es**

- **Ã‰lÃ¨ves** : Ne peuvent voir/modifier QUE leurs propres vÅ“ux
- **Admins** : AccÃ¨s Ã  toutes les donnÃ©es avec rÃ´le ADMIN
- **SuperAdmins** : AccÃ¨s aux opÃ©rations de purge systÃ¨me

---

## Tests & QualitÃ©

### 1. **Script de gÃ©nÃ©ration de donnÃ©es de test**

```bash
cd backend
./generate-test-voeux.sh
```

**Ce script fait :**
1. Import de 50 Ã©lÃ¨ves via CSV
2. Import de 28 activitÃ©s via CSV
3. Import de 10 salles via CSV
4. GÃ©nÃ©ration automatique de vÅ“ux pour tous les Ã©lÃ¨ves (via API `/api/voeux/soumettre`)

---

### 2. **Tests unitaires (Backend)**

```bash
cd backend
./mvnw test
```

**Classes testÃ©es :**
- `VoeuxServiceTest` : Validation des contraintes mÃ©tier
- `AffectationServiceTest` : Algorithme Timefold (mock)
- `PdfGenerationServiceTest` : GÃ©nÃ©ration PDF

---

### 3. **Tests d'intÃ©gration**

```bash
./mvnw verify
```

**Tests avec base H2 en mÃ©moire :**
- Tests des endpoints REST avec `@SpringBootTest`
- Tests des repositories JPA
- Tests de la chaÃ®ne complÃ¨te (Controller â†’ Service â†’ Repository)

---

## Performances & Optimisation

### 1. **Chargement EAGER vs LAZY**

```java
// EAGER pour les relations utilisÃ©es frÃ©quemment
@ManyToOne(fetch = FetchType.EAGER)
private Lycee lycee;

// LAZY par dÃ©faut pour les collections
@OneToMany(mappedBy = "eleve", fetch = FetchType.LAZY)
private List<Voeu> voeux;
```

---

### 2. **Pagination (si nÃ©cessaire)**

```java
@GetMapping("/admin/eleves")
public Page<EleveDTO> getAllEleves(
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "20") int size
) {
    return eleveService.findAll(PageRequest.of(page, size));
}
```

---

### 3. **GÃ©nÃ©ration asynchrone de PDFs**

```java
@Configuration
@EnableAsync
public class AsyncConfig {
    @Bean(name = "taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(4);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("pdf-gen-");
        executor.initialize();
        return executor;
    }
}
```

---

## Monitoring & Logs

### 1. **Actuator (Spring Boot)**

Endpoints de monitoring :
- `GET /actuator/health` : Ã‰tat du service
- `GET /actuator/metrics` : MÃ©triques JVM
- `GET /actuator/info` : Informations sur l'application

---

### 2. **Logs structurÃ©s**

```java
@Slf4j
@Service
public class VoeuxService {
    public void soumettreVoeux(VoeuxSubmissionDTO submission) {
        log.info("ğŸ“ Soumission vÅ“ux Ã©lÃ¨ve {}", submission.getEleveId());
        
        try {
            // ...
            log.info("âœ… VÅ“ux soumis avec succÃ¨s pour Ã©lÃ¨ve {}", eleveId);
        } catch (ValidationException ex) {
            log.warn("âŒ Validation Ã©chouÃ©e : {}", ex.getMessage());
            throw ex;
        }
    }
}
```

---

### 3. **Affichage des logs Docker**

```bash
# Logs en temps rÃ©el
docker-compose logs -f

# Logs filtrÃ©s
docker-compose logs -f backend | grep "ERROR"
```

---

## ğŸ”„ Migration ID â†’ idNational (Novembre 2025)

### Vue d'ensemble

**Date de migration** : 13 novembre 2025  
**Statut** : âœ… ComplÃ©tÃ©e et validÃ©e  
**Objectif** : Remplacer l'authentification par ID numÃ©rique auto-incrÃ©mentÃ© par un ID National fonctionnel

### ProblÃ©matique Initiale

**Avant migration :**
- Authentification Ã©lÃ¨ve : `eleveId: Long` (1, 2, 3, 4...)
- ProblÃ¨me : ID auto-incrÃ©mentÃ© non conforme aux identifiants rÃ©els (ex: INE)
- Risque : PrÃ©dictibilitÃ© des ID, confusion avec clÃ© primaire technique

**AprÃ¨s migration :**
- Authentification Ã©lÃ¨ve : `idNational: String` (ex: `120890177FA`)
- Format : AlphanumÃ©rique majuscule (12 chiffres + 2 lettres)
- Avantage : Identifiant rÃ©el, unique, sÃ©curisÃ©

---

### StratÃ©gie Double Identifiant

```java
@Entity
public class Eleve {
    @Id @GeneratedValue
    private Long id; // âœ… ClÃ© primaire technique (FK internes)
    
    @Column(nullable = false, unique = true, length = 50)
    private String idNational; // âœ… Identifiant fonctionnel (authentification)
}
```

**Pourquoi conserver `id` (Long) ?**
1. **StabilitÃ© des FK** : Toutes les relations existantes (`voeux.eleve_id`, `affectations.eleve_id`, etc.) continuent de fonctionner sans modification
2. **Performance** : Les jointures sur `BIGINT` restent plus rapides que sur `VARCHAR`
3. **CompatibilitÃ©** : Pas de migration lourde du schÃ©ma relationnel

**RÃ´le de `idNational` :**
- Authentification Ã©lÃ¨ve (endpoint `/api/voeux/auth`)
- Affichage dans l'interface admin
- Import CSV Ã©lÃ¨ves
- TÃ©lÃ©chargement planning PDF

---

### Modifications Backend (11 fichiers)

#### 1. **Eleve.java** - EntitÃ© JPA
```java
@Column(nullable = false, unique = true, length = 50)
private String idNational;
```

#### 2. **EleveRepository.java** - Nouvelles mÃ©thodes
```java
Optional<Eleve> findByIdNationalAndNom(String idNational, String nom);
Optional<Eleve> findByIdNational(String idNational);
```

#### 3. **AuthRequestDTO.java** - Modification payload auth
```java
// Avant
private Long eleveId;

// AprÃ¨s
private String idNational; // Format: 120890177FA
```

#### 4. **AuthResponseDTO.java** - Ajout champ
```java
private String idNational; // RenvoyÃ© aprÃ¨s authentification
```

#### 5. **VoeuxService.java** - Logique authentification
```java
public AuthResponseDTO verifierEleve(String idNational, String nom) {
    Eleve eleve = eleveRepository.findByIdNationalAndNom(idNational, nom)
        .orElseThrow(() -> new ResourceNotFoundException("Ã‰lÃ¨ve non trouvÃ©"));
    
    return AuthResponseDTO.builder()
        .eleveId(eleve.getId()) // âœ… Session continue avec id technique
        .idNational(eleve.getIdNational()) // âœ… AffichÃ© dans UI
        .nom(eleve.getNom())
        .prenom(eleve.getPrenom())
        .build();
}
```

#### 6. **AdminImportService.java** - Import CSV
```java
public void importEleves(MultipartFile file) {
    CSVRecord record : records) {
        String idNational = record.get("idNational");
        
        // Validation unicitÃ©
        if (eleveRepository.findByIdNational(idNational).isPresent()) {
            throw new ValidationException("ID National dÃ©jÃ  existant: " + idNational);
        }
        
        Eleve eleve = new Eleve();
        eleve.setIdNational(idNational);
        // ...
    }
}
```

#### 7. **EleveAdminController.java** - DTO Admin
```java
private Map<String, Object> convertToDTO(Eleve eleve) {
    dto.put("id", eleve.getId());
    dto.put("nom", eleve.getNom());
    dto.put("prenom", eleve.getPrenom());
    dto.put("idNational", eleve.getIdNational()); // âœ… AjoutÃ©
    // ...
}
```

#### 8. **data.sql** - DonnÃ©es initiales
```sql
INSERT INTO eleves (nom, prenom, id_national, lycee_id, demi_journee)
VALUES 
  ('DUPONT', 'Jean', '120890177FA', 1, 'JOUR1_MATIN'),
  ('MARTIN', 'Sophie', '120113325CK', 2, 'JOUR1_APRES_MIDI');
```

#### 9. **V2__add_id_national.sql** - Migration Flyway
```sql
-- Ajout colonne
ALTER TABLE eleves ADD COLUMN id_national VARCHAR(50);

-- GÃ©nÃ©ration valeurs temporaires (Ã  remplacer par import CSV)
UPDATE eleves SET id_national = LPAD(id::text, 12, '0') || 
    substring('ABCDEFGHIJKLMNOPQRSTUVWXYZ' from (random() * 25 + 1)::int for 1) ||
    substring('ABCDEFGHIJKLMNOPQRSTUVWXYZ' from (random() * 25 + 1)::int for 1);

-- Contraintes
ALTER TABLE eleves ALTER COLUMN id_national SET NOT NULL;
ALTER TABLE eleves ADD CONSTRAINT uk_eleve_id_national UNIQUE (id_national);
CREATE INDEX idx_eleve_id_national ON eleves(id_national);
```

---

### Modifications Frontend (4 fichiers)

#### 1. **eleve.model.ts** - Interfaces TypeScript
```typescript
export interface AuthRequest {
  idNational: string; // Avant: eleveId: number
  nom: string;
}

export interface AuthResponse {
  eleveId: number; // âœ… ConservÃ© pour session
  idNational: string; // âœ… AjoutÃ© pour affichage
  nom: string;
  prenom: string;
  // ...
}

export interface Eleve {
  id: number;
  nom: string;
  prenom: string;
  idNational: string; // âœ… AjoutÃ©
  // ...
}
```

#### 2. **identification.component.ts** - Formulaire
```typescript
identificationForm = this.fb.group({
  idNational: ['', [
    Validators.required,
    Validators.minLength(5),
    Validators.maxLength(50),
    Validators.pattern(/^[A-Z0-9]+$/) // Alphanum majuscule
  ]],
  nom: ['', Validators.required]
});

onSubmit() {
  const { idNational, nom } = this.identificationForm.value;
  this.voeuxService.verifierEleve(idNational, nom).subscribe(/* ... */);
}
```

#### 3. **identification.component.html** - Template
```html
<label for="idNational">ID National *</label>
<input
  id="idNational"
  formControlName="idNational"
  placeholder="Ex: 120890177FA"
  maxlength="50"
/>

<div *ngIf="identificationForm.get('idNational')?.errors?.['pattern']">
  Format invalide (alphanumÃ©rique majuscule uniquement)
</div>
```

#### 4. **eleves.component.html** - Liste admin
```html
<div class="eleve-name">
  <strong>{{ eleve.prenom }} {{ eleve.nom }}</strong>
  <small>ID National: {{ eleve.idNational }}</small>
</div>

<!-- Modal dÃ©tails -->
<div class="detail-item">
  <label>ID National</label>
  <span>{{ selectedEleve.idNational }}</span>
</div>
```

---

### Test Data & Scripts

#### test-data/eleves.csv
```csv
nom,prenom,idNational,lycee,ville,codePostal,demiJournee
DUPONT,Jean,120890177FA,LycÃ©e Victor Hugo,Paris,75001,JOUR1_MATIN
MARTIN,Sophie,120113325CK,LycÃ©e Voltaire,Paris,75011,JOUR1_APRES_MIDI
BERNARD,Lucas,120234556AB,LycÃ©e Descartes,Tours,37000,JOUR2_MATIN
```

#### backend/generate-test-voeux-v2.sh (Nouveau)
```bash
#!/bin/bash
# GÃ©nÃ©ration automatique d'Ã©lÃ¨ves avec ID National
# Format: 12 chiffres alÃ©atoires + 2 lettres alÃ©atoires
# Exemple: 184470245033YF

v_id_national := 
    lpad((floor(random() * 1000000000000)::bigint)::text, 12, '0') || 
    v_lettre1 || v_lettre2;

# VÃ©rification unicitÃ©
EXIT WHEN NOT EXISTS (SELECT 1 FROM eleves WHERE id_national = v_id_national);
```

---

### Validation & Compilation

**Backend :**
```bash
cd backend
mvn clean package -DskipTests
# âœ… BUILD SUCCESS (8.6s)
```

**Frontend :**
```bash
cd frontend
npm run build
# âœ… Build complete (9.5s)
# âš ï¸ Warnings mineurs (budget CSS) - non bloquants
```

**Docker :**
```bash
docker-compose down -v
docker-compose up --build -d
# âœ… Services dÃ©marrÃ©s : postgres, backend, frontend
```

---

### Exemples ID National GÃ©nÃ©rÃ©s

#### Format Standard
```
120890177FA  (DUPONT Jean)
220113325CK  (MARTIN Sophie)
315234556AB  (BERNARD Lucas)
410345667BC  (PETIT Emma)
520456778CD  (DURAND Thomas)
```

#### Script de test gÃ©nÃ¨re automatiquement
```sql
184470245033YF
478146075908LV
653720187849LT
847589473596GK
287351862507RH
```

---

### Points Importants

#### âœ… Ce qui FONCTIONNE
1. **Double identifiant** : `id` (PK) + `idNational` (auth)
2. **FK intactes** : Aucune modification des relations
3. **Import CSV** : Validation unicitÃ© automatique
4. **Authentification** : `findByIdNationalAndNom()`
5. **Affichage admin** : ID National visible dans liste/modal
6. **Session** : Continue d'utiliser `eleveId` (Long) aprÃ¨s auth

#### âš ï¸ Ce qui RESTE INCHANGÃ‰
1. **VoeuxSubmissionDTO** : Utilise `eleveId` (session)
2. **Routes `/api/voeux/{eleveId}`** : ID session (Long)
3. **FK database** : `voeux.eleve_id`, `affectations.eleve_id` (BIGINT)
4. **Ticket.java** : FK sur `eleve_id` (Long)

#### ğŸ“ BONNES PRATIQUES
1. **Import CSV** : Toujours fournir `idNational` unique
2. **Format** : AlphanumÃ©rique majuscule, 5-50 caractÃ¨res
3. **Validation** : Pattern `/^[A-Z0-9]+$/` cÃ´tÃ© frontend
4. **Logs** : Tracer auth par idNational (anonymisÃ© si besoin)

---

### Flux Authentification Complet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Ã‰lÃ¨ve saisit                             â”‚
â”‚    idNational = "120890177FA"               â”‚
â”‚    nom = "DUPONT"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. POST /api/voeux/auth                     â”‚
â”‚    Body: { idNational, nom }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. VoeuxService.verifierEleve()             â”‚
â”‚    findByIdNationalAndNom(idNational, nom)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Retour AuthResponseDTO                   â”‚
â”‚    {                                        â”‚
â”‚      eleveId: 42,        // âœ… Session      â”‚
â”‚      idNational: "120...",// âœ… Affichage   â”‚
â”‚      nom: "DUPONT",                         â”‚
â”‚      prenom: "Jean",                        â”‚
â”‚      ...                                    â”‚
â”‚    }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Frontend stocke                          â”‚
â”‚    sessionStorage.setItem('eleveId', 42)    â”‚
â”‚    Affiche: "Bonjour Jean (120890177FA)"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Soumission vÅ“ux                          â”‚
â”‚    POST /api/voeux/soumettre                â”‚
â”‚    Body: { eleveId: 42, voeux: [...] }      â”‚
â”‚    âœ… Continue avec id technique            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Rollback (si nÃ©cessaire)

**En cas de problÃ¨me critique :**

```sql
-- Supprimer contraintes
ALTER TABLE eleves DROP CONSTRAINT uk_eleve_id_national;
DROP INDEX idx_eleve_id_national;

-- Supprimer colonne
ALTER TABLE eleves DROP COLUMN id_national;

-- Restaurer code backend
git revert <commit-hash>
```

**Recompilation :**
```bash
mvn clean package -DskipTests
docker-compose up --build -d
```

---

**âœ… Migration complÃ©tÃ©e avec succÃ¨s - SystÃ¨me opÃ©rationnel**

---