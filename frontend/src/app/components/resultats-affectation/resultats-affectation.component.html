<div class="affectation-container">
  <div class="header">
    <button class="btn-back" routerLink="/admin/dashboard">
      â† Retour au tableau de bord
    </button>
    <h1>ğŸ¯ RÃ©sultats d'Affectation</h1>
    <button class="btn-delete-all" (click)="deleteAllAffectations()" [disabled]="!hasResults" title="Supprimer toutes les affectations et PDFs">
      ğŸ—‘ï¸ Supprimer Tout
    </button>
    <p class="subtitle">Algorithme d'optimisation des affectations Ã©lÃ¨ves-activitÃ©s</p>
  </div>

  <!-- ContrÃ´les -->
  <div class="controls-card">
    <button 
      class="btn-launch" 
      (click)="lancerAlgorithme()" 
      [disabled]="isRunning"
      [class.running]="isRunning">
      <span *ngIf="!isRunning">ğŸš€ Lancer l'algorithme</span>
      <span *ngIf="isRunning">â³ Calcul en cours...</span>
    </button>
    
    <button 
      class="btn-generate-tickets" 
      (click)="genererTousLesTickets()" 
      [disabled]="!hasResults || isGeneratingTickets"
      *ngIf="hasResults">
      <span *ngIf="!isGeneratingTickets">ğŸ“„ GÃ©nÃ©rer tous les tickets PDF</span>
      <span *ngIf="isGeneratingTickets">â³ GÃ©nÃ©ration en cours...</span>
    </button>
    
    <div class="status" *ngIf="isRunning">
      <div class="spinner"></div>
      <p>L'algorithme est en cours d'exÃ©cution (jusqu'Ã  5 minutes)</p>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="stats-grid" *ngIf="hasResults">
    <div class="stat-card score">
      <div class="stat-icon">ğŸ†</div>
      <div class="stat-content">
        <h3>Score Total</h3>
        <p class="stat-value">{{ score }}</p>
        <small>Hard: {{ hardScore }} | Soft: {{ softScore }}</small>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-content">
        <h3>Total Ã‰lÃ¨ves</h3>
        <p class="stat-value">{{ calculateStats().total }}</p>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">âœ…</div>
      <div class="stat-content">
        <h3>AffectÃ©s</h3>
        <p class="stat-value">{{ calculateStats().affectes }}</p>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-content">
        <h3>Non AffectÃ©s</h3>
        <p class="stat-value">{{ calculateStats().nonAffectes }}</p>
      </div>
    </div>

    <div class="stat-card satisfaction">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-content">
        <h3>Taux Satisfaction</h3>
        <p class="stat-value">{{ calculateStats().tauxSatisfaction }}%</p>
      </div>
    </div>
  </div>

  <!-- Tableau des affectations -->
  <div class="table-card" *ngIf="hasResults">
    <h2>ğŸ“‹ Affectations dÃ©taillÃ©es ({{ affectations.length }})</h2>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Ã‰lÃ¨ve</th>
            <th>LycÃ©e</th>
            <th>ActivitÃ©</th>
            <th>Type</th>
            <th>Salle</th>
            <th>CrÃ©neau</th>
            <th>Demi-journÃ©e</th>
            <th>Action</th>
            <th>Ticket</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let affectation of affectations">
            <td><strong>{{ affectation.eleve.nom }} {{ affectation.eleve.prenom }}</strong></td>
            <td>{{ affectation.eleve.lycee?.nom || 'N/A' }}</td>
            <td>
              <span *ngIf="affectation.assignedSession">
                {{ affectation.assignedSession.activite.titre }}
              </span>
              <span *ngIf="!affectation.assignedSession" class="no-session">
                Non affectÃ©
              </span>
            </td>
            <td>
              <span *ngIf="affectation.assignedSession" class="badge type-{{ affectation.assignedSession.activite.type }}">
                {{ affectation.assignedSession.activite.type }}
              </span>
            </td>
            <td>{{ affectation.assignedSession?.salle?.nom || '-' }}</td>
            <td>{{ affectation.assignedSession?.creneau?.libelle || '-' }}</td>
            <td>
              <span *ngIf="affectation.assignedSession" class="badge dj-{{ affectation.assignedSession.creneau?.demiJournee }}">
                {{ (affectation.assignedSession.creneau?.demiJournee || '') | demiJourneeLabel }}
              </span>
            </td>
            <td>
              <select 
                class="session-select"
                [value]="affectation.assignedSession?.id || ''"
                (change)="onSessionChange(affectation, $event)">
                <option value="">-- Choisir session --</option>
                <option 
                  *ngFor="let session of getSessionsForEleve(affectation)" 
                  [value]="session.id">
                  {{ session.activiteTitre }} - {{ session.salleNom }} - {{ session.creneauLibelle }}
                </option>
              </select>
            </td>
            <td>
              <div class="ticket-actions">
                <button 
                  class="btn-ticket-download" 
                  (click)="telechargerTicketEleve(affectation.eleve)"
                  title="TÃ©lÃ©charger le ticket">
                  â¬‡ï¸
                </button>
                <button 
                  class="btn-ticket-regenerate" 
                  (click)="regenererTicketEleve(affectation.eleve)"
                  title="RÃ©gÃ©nÃ©rer le ticket">
                  ğŸ”„
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="affectations.length === 0">
            <td colspan="9" class="empty">Aucune affectation disponible</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Message si pas de rÃ©sultats -->
  <div class="no-results" *ngIf="!hasResults && !isRunning">
    <div class="no-results-icon">ğŸ“­</div>
    <h3>Aucun rÃ©sultat disponible</h3>
    <p>Lancez l'algorithme pour gÃ©nÃ©rer les affectations</p>
  </div>
</div>
