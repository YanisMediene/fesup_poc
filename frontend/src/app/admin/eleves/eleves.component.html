<div class="eleves-container">
  <div class="header">
    <button class="btn-back" (click)="goBack()">
      <span class="icon">â†</span> Retour
    </button>
    <h1>ğŸ‘¨â€ğŸ“ Gestion des Ã‰lÃ¨ves</h1>
    <div class="spacer"></div>
  </div>

  <!-- Statistiques -->
  <div class="stats-grid" *ngIf="stats">
    <div class="stat-card">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total Ã©lÃ¨ves</div>
    </div>
    <div class="stat-card success">
      <div class="stat-icon">âœ…</div>
      <div class="stat-value">{{ stats.avecVoeux }}</div>
      <div class="stat-label">VÅ“ux soumis</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-icon">â³</div>
      <div class="stat-value">{{ stats.sansVoeux }}</div>
      <div class="stat-label">En attente</div>
    </div>
    <div class="stat-card info">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-value">{{ stats.tauxCompletion | number:'1.0-1' }}%</div>
      <div class="stat-label">Taux de complÃ©tion</div>
    </div>
  </div>

  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-bar">
    <div class="filter-buttons">
      <button 
        class="filter-btn" 
        [class.active]="filterStatus === 'all'"
        (click)="setFilter('all')">
        Tous ({{ eleves.length }})
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterStatus === 'with'"
        (click)="setFilter('with')">
        âœ“ Avec vÅ“ux ({{ stats?.avecVoeux || 0 }})
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterStatus === 'without'"
        (click)="setFilter('without')">
        âš ï¸ Sans vÅ“ux ({{ stats?.sansVoeux || 0 }})
      </button>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Rechercher (nom, prÃ©nom, lycÃ©e)..."
        (input)="onSearchChange($event)"
        [value]="searchTerm"
      />
    </div>

    <button 
      class="btn-add" 
      (click)="openAddModal()"
      [disabled]="loading"
      title="Ajouter un Ã©lÃ¨ve">
      â• Ajouter
    </button>

    <button 
      class="btn-delete-all" 
      (click)="deleteAllEleves()"
      [disabled]="loading || eleves.length === 0"
      title="Supprimer tous les Ã©lÃ¨ves">
      ğŸ—‘ï¸ Supprimer Tout
    </button>
  </div>

  <!-- Liste des Ã©lÃ¨ves -->
  <div class="table-container">
    <div class="loading" *ngIf="loading">Chargement...</div>
    
    <table *ngIf="!loading && filteredEleves.length > 0">
      <thead>
        <tr>
          <th>Ã‰lÃ¨ve</th>
          <th>LycÃ©e</th>
          <th>Demi-journÃ©e</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let eleve of filteredEleves">
          <td>
            <div class="eleve-name">
              <strong>{{ eleve.prenom }} {{ eleve.nom }}</strong>
              <small>ID National: {{ eleve.idNational }}</small>
            </div>
          </td>
          <td>
            <div class="lycee-info" *ngIf="eleve.lycee">
              <strong>{{ eleve.lycee.nom }}</strong>
              <small>{{ eleve.lycee.ville }} ({{ eleve.lycee.codePostal }})</small>
            </div>
          </td>
          <td>
            <span class="badge badge-time">
              {{ eleve.demiJournee | demiJourneeLabel }}
            </span>
          </td>
          <td>
            <span class="badge" [ngClass]="getStatusBadgeClass(eleve)">
              {{ getStatusText(eleve) }}
            </span>
          </td>
          <td class="actions-cell">
            <button class="btn-icon btn-view" (click)="viewDetails(eleve)" title="Voir dÃ©tails">
              ğŸ‘ï¸
            </button>
            <button 
              class="btn-icon btn-reset" 
              (click)="resetVoeux(eleve)" 
              [disabled]="eleve.nbVoeux === 0"
              title="RÃ©initialiser vÅ“ux">
              ğŸ”„
            </button>
            <button class="btn-icon btn-delete" (click)="deleteEleve(eleve)" title="Supprimer">
              ğŸ—‘ï¸
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="!loading && filteredEleves.length === 0">
      <p *ngIf="searchTerm || filterStatus !== 'all'">Aucun Ã©lÃ¨ve ne correspond aux filtres</p>
      <p *ngIf="!searchTerm && filterStatus === 'all'">Aucun Ã©lÃ¨ve pour le moment</p>
    </div>
  </div>

  <!-- Modal dÃ©tails Ã©lÃ¨ve -->
  <div class="modal" *ngIf="showDetails && selectedEleve">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“‹ DÃ©tails de l'Ã©lÃ¨ve</h2>
        <button class="btn-close" (click)="closeDetails()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div class="detail-section">
          <h3>Informations personnelles</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Nom complet</label>
              <span>{{ selectedEleve.prenom }} {{ selectedEleve.nom }}</span>
            </div>
            <div class="detail-item">
              <label>ID National</label>
              <span>{{ selectedEleve.idNational }}</span>
            </div>
            <div class="detail-item">
              <label>LycÃ©e</label>
              <span *ngIf="selectedEleve.lycee">
                {{ selectedEleve.lycee.nom }}<br/>
                <small>{{ selectedEleve.lycee.ville }} ({{ selectedEleve.lycee.codePostal }})</small>
              </span>
            </div>
            <div class="detail-item">
              <label>Demi-journÃ©e</label>
              <span>{{ selectedEleve.demiJournee | demiJourneeLabel }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Statut des vÅ“ux</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Statut</label>
              <span class="badge" [ngClass]="getStatusBadgeClass(selectedEleve)">
                {{ selectedEleve.voeuxSoumis ? 'VÅ“ux soumis âœ“' : 'En cours de saisie â³' }}
              </span>
            </div>
            <div class="detail-item">
              <label>Nombre de vÅ“ux</label>
              <span>{{ selectedEleve.nbVoeux }} / 5</span>
            </div>
            <div class="detail-item" *ngIf="selectedEleve.dateSoumission">
              <label>Date de soumission</label>
              <span>{{ selectedEleve.dateSoumission | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedEleve.voeux && selectedEleve.voeux.length > 0">
          <h3>Liste des vÅ“ux ({{ selectedEleve.voeux.length }})</h3>
          <div class="voeux-list">
            <div class="voeu-card" *ngFor="let voeu of selectedEleve.voeux">
              <div class="voeu-priority">{{ voeu.priorite }}</div>
              <div class="voeu-content">
                <div class="voeu-title">{{ voeu.activite.titre }}</div>
                <div class="voeu-meta">
                  <span class="badge badge-type">{{ voeu.activite.type }}</span>
                  <span class="badge badge-voeu-type">{{ voeu.typeVoeu }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="!selectedEleve.voeux || selectedEleve.voeux.length === 0">
          <p class="no-voeux">Aucun vÅ“u enregistrÃ© pour cet Ã©lÃ¨ve</p>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          class="btn-secondary" 
          (click)="resetVoeux(selectedEleve)"
          [disabled]="selectedEleve.nbVoeux === 0">
          ğŸ”„ RÃ©initialiser les vÅ“ux
        </button>
        <button class="btn-primary" (click)="closeDetails()">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter un Ã©lÃ¨ve -->
  <div class="modal" *ngIf="showAddModal">
    <div class="modal-content modal-form">
      <div class="modal-header">
        <h2>â• Ajouter un Ã©lÃ¨ve</h2>
        <button class="btn-close" (click)="closeAddModal()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>

        <form (ngSubmit)="createEleve()">
          <div class="form-group">
            <label for="nom">Nom <span class="required">*</span></label>
            <input 
              id="nom"
              type="text" 
              [(ngModel)]="newEleve.nom"
              name="nom"
              placeholder="NOM"
              required
              [disabled]="loading"
            />
          </div>

          <div class="form-group">
            <label for="prenom">PrÃ©nom <span class="required">*</span></label>
            <input 
              id="prenom"
              type="text" 
              [(ngModel)]="newEleve.prenom"
              name="prenom"
              placeholder="PrÃ©nom"
              required
              [disabled]="loading"
            />
          </div>

          <div class="form-group">
            <label for="lycee">LycÃ©e <span class="required">*</span></label>
            <select 
              id="lycee"
              [(ngModel)]="newEleve.lyceeId"
              name="lyceeId"
              required
              [disabled]="loading || lycees.length === 0"
            >
              <option [value]="0" disabled>-- SÃ©lectionner un lycÃ©e --</option>
              <option *ngFor="let lycee of lycees" [value]="lycee.id">
                {{ lycee.nom }} - {{ lycee.ville }}
              </option>
            </select>
            <small *ngIf="lycees.length === 0" class="warning-text">
              âš ï¸ Aucun lycÃ©e disponible. Veuillez d'abord crÃ©er des lycÃ©es.
            </small>
          </div>

          <div class="form-group">
            <label for="demiJournee">Demi-journÃ©e <span class="required">*</span></label>
            <select 
              id="demiJournee"
              [(ngModel)]="newEleve.demiJournee"
              name="demiJournee"
              required
              [disabled]="loading"
            >
              <option value="JOUR1_MATIN">ğŸ“… Jour 1 - ğŸŒ… Matin</option>
              <option value="JOUR1_APRES_MIDI">ğŸ“… Jour 1 - ğŸŒ† AprÃ¨s-midi</option>
              <option value="JOUR2_MATIN">ğŸ“… Jour 2 - ğŸŒ… Matin</option>
              <option value="JOUR2_APRES_MIDI">ğŸ“… Jour 2 - ğŸŒ† AprÃ¨s-midi</option>
            </select>
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn-secondary" 
              (click)="closeAddModal()"
              [disabled]="loading">
              Annuler
            </button>
            <button 
              type="submit" 
              class="btn-primary" 
              [disabled]="loading || lycees.length === 0">
              {{ loading ? 'CrÃ©ation...' : 'âœ“ CrÃ©er l\'Ã©lÃ¨ve' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
